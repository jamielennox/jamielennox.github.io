<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Kerberos | jamielennox.net]]></title>
  <link href="http://www.jamielennox.net/blog/categories/kerberos/atom.xml" rel="self"/>
  <link href="http://www.jamielennox.net/"/>
  <updated>2015-02-23T11:05:27+11:00</updated>
  <id>http://www.jamielennox.net/</id>
  <author>
    <name><![CDATA[Jamie Lennox]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Step-by-Step: Kerberized Keystone]]></title>
    <link href="http://www.jamielennox.net/blog/2015/02/12/step-by-step-kerberized-keystone/"/>
    <updated>2015-02-12T17:20:42+11:00</updated>
    <id>http://www.jamielennox.net/blog/2015/02/12/step-by-step-kerberized-keystone</id>
    <content type="html"><![CDATA[Authentication plugins in Keystoneclient have gotten to the point where they are sufficiently well deployed that we can start to do interesting additional forms of authentication.
As Kerberos is a commonly requested authentication mechanism here is a simple, single domain keystone setup using Kerberos authentication.
They are not necessarily how you would setup a production deployment, but should give you the information you need to configure that yourself.

They create:

 - A [FreeIPA](https://www.freeipa.org) server machine called `ipa.test.jamielennox.net`
 - A [Packstack](https://openstack.redhat.com/Quickstart) all in one deployment of OpenStack called `openstack.test.jamielennox.net`

<!-- more -->

Notes:

 - I use the realm `TEST.JAMIELENNOX.NET`. There is no meaning to this domain, it doesn&#8217;t exist or make any difference to the deployment.
 - I am using a single domain deployment, so regular users and service users are intermingled.
   There is no great benefit to this because the Kerberos plugin only supports the Keystone v3 API (so you have to be domain aware), however it a couple of steps.
   Generally when doing a deployment like this I would put the IPA users in there own domain.

Disclaimer:

 - The goal of Kerberos authentication is obviously to enable both the command line and horizon interfaces to use your existing Kerberos ticket.
   At the time of writing the [openstackclient](http://docs.openstack.org/developer/python-openstackclient/) is really the only client capable of using plugins.
   I am also [working](https://review.openstack.org/#/c/153910/) [on](https://review.openstack.org/#/c/153174/) the patches required to enable horizon for SSO.
   There are obviously no promises that will be ready and accepted for the Kilo release, but I&#8217;m hoping so.

##Part 1 - Install FreeIPA

From a brand new centos 7 image:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@ipa]# yum update -y</span>
</span><span class='line'><span class="go">[root@ipa]# hostnamectl set-hostname ipa.test.jamielennox.net</span>
</span></code></pre></td></tr></table></div></figure>

Now install the FreeIPA server.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@ipa]# yum install ipa-server bind-dyndb-ldap -y</span>
</span><span class='line'><span class="go">[root@ipa]# ipa-server-install</span>
</span></code></pre></td></tr></table></div></figure>

I&#8217;ve ignored the details here, generally having correctly set the hostname the defaults are correct for me, the only thing I generally do is opt to configuring bind for DNS.
This is the reason for installing `bind-dyndb-ldap` and you can skip it if you don&#8217;t install bind, however you will need to edit your `/etc/hosts` file for the IPA server for the other machines as IPA relies on hostnames.

Pay particular attention to the username you give to the `admin` user as this user will be used from keystone later.
If you are unfamiliar with FreeIPA I suggest you test out the web interface, this is where your users will be registered.
As FreeIPA expects to be on a routable address you will need to add the hostname to `/etc/hosts` of the client machine to use the web service.

##Part 2 - Register as a FreeIPA Client

The first thing I like to do is register the machine as a FreeIPA client machine.
After registering the machine comes available for us to fetch Kerberos tickets from (and SSL certs, etc).

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# yum update -y</span>
</span><span class='line'><span class="go">[root@openstack]# hostnamectl set-hostname openstack.test.jamielennox.net</span>
</span><span class='line'><span class="gp">[root@openstack]# vim /etc/resolv.conf  #</span> and update your DNS server IP of the ipa machine.
</span><span class='line'><span class="go">[root@openstack]# yum install ipa-client -y</span>
</span><span class='line'><span class="go">[root@openstack]# ipa-client-install</span>
</span></code></pre></td></tr></table></div></figure>

Again, having correctly set a hostname and DNS server the default options are correct for me.
You&#8217;ll need to provide the admin user and password from setting up the FreeIPA server.

##Part 3 - Install Packstack

Packstack is a series of wrappers around the upstream puppet scripts that integrates well with RHEL/Centos, it will deploy the latest packaged version which is currently Juno.
You could use devstack or any alternative deployment here.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">[root@openstack]# setenforce 0  #</span> :<span class="o">(</span>
</span><span class='line'><span class="go">[root@openstack]# yum install -y https://rdo.fedorapeople.org/rdo-release.rpm</span>
</span><span class='line'><span class="go">[root@openstack]# yum install -y openstack-packstack</span>
</span><span class='line'><span class="go">[root@openstack]# packstack --allinone</span>
</span></code></pre></td></tr></table></div></figure>

The `&#8211;allinone` option configures the entire OpenStack deployment on this machine, see [the docs](https://openstack.redhat.com/Docs) for more detailed deployments methods.

##Part 4 - Convert Keystone to Apache

To use kerberos authentication the keystone server uses the `mod_auth_kerb` Apache module. We therefore need to run the keystone server within Apache rather than from the script.
Ideally here we would have generated an answer file and told Packstack to use the `httpd` deployment method (which it can do) however this never seems to work for me, so I&#8217;ll do it manually. YMMV.

Stop the existing keystone server and prevent it starting on boot:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# systemctl stop openstack-keystone</span>
</span><span class='line'><span class="go">[root@openstack]# systemctl disable openstack-keystone</span>
</span></code></pre></td></tr></table></div></figure>

There are many ways you could setup keystone within Apache. I don&#8217;t think the [official docs](http://docs.openstack.org/developer/keystone/apache-httpd.html) explain this very well but you can deploy it as you would any other `mod_wsgi` python site.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# mkdir /var/www/keystone</span>
</span><span class='line'><span class="go">[root@openstack]# ln -s /usr/share/keystone/keystone.wsgi /var/www/keystone/admin</span>
</span><span class='line'><span class="go">[root@openstack]# ln -s /usr/share/keystone/keystone.wsgi /var/www/keystone/main</span>
</span></code></pre></td></tr></table></div></figure>

This is the httpd config file I used initially:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nb">Listen</span> <span class="m">5000</span>
</span><span class='line'><span class="nb">Listen</span> <span class="m">35357</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;VirtualHost</span> <span class="s">*:5000</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">ServerName</span> openstack.test.jamielennox.net
</span><span class='line'>
</span><span class='line'>  <span class="nb">DocumentRoot</span> <span class="s2">&quot;/var/www/keystone&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;Directory</span> <span class="s">&quot;/var/www/keystone&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nb">Options</span> Indexes FollowSymLinks MultiViews
</span><span class='line'>    <span class="nb">AllowOverride</span> <span class="k">None</span>
</span><span class='line'>    <span class="nb">Require</span> <span class="k">all</span> granted
</span><span class='line'>  <span class="nt">&lt;/Directory&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c">## Logging</span>
</span><span class='line'>  <span class="nb">ErrorLog</span> <span class="s2">&quot;/var/log/httpd/keystone_wsgi_main_error.log&quot;</span>
</span><span class='line'>  <span class="nb">ServerSignature</span> <span class="k">Off</span>
</span><span class='line'>  <span class="nb">CustomLog</span> <span class="s2">&quot;/var/log/httpd/keystone_wsgi_main_access.log&quot;</span> combined
</span><span class='line'>  <span class="nb">WSGIDaemonProcess</span> keystone_main <span class="k">group</span>=keystone processes=1 threads=4 <span class="k">user</span>=keystone
</span><span class='line'>  <span class="nb">WSGIProcessGroup</span> keystone_main
</span><span class='line'>  <span class="nb">WSGIScriptAlias</span> / <span class="s2">&quot;/var/www/keystone/main&quot;</span>
</span><span class='line'><span class="nt">&lt;/VirtualHost&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;VirtualHost</span> <span class="s">*:35357</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">ServerName</span> openstack.test.jamielennox.net
</span><span class='line'>
</span><span class='line'>  <span class="nb">DocumentRoot</span> <span class="s2">&quot;/var/www/keystone&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;Directory</span> <span class="s">&quot;/var/www/keystone&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nb">Options</span> Indexes FollowSymLinks MultiViews
</span><span class='line'>    <span class="nb">AllowOverride</span> <span class="k">None</span>
</span><span class='line'>    <span class="nb">Require</span> <span class="k">all</span> granted
</span><span class='line'>  <span class="nt">&lt;/Directory&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c">## Logging</span>
</span><span class='line'>  <span class="nb">ErrorLog</span> <span class="s2">&quot;/var/log/httpd/keystone_wsgi_admin_error.log&quot;</span>
</span><span class='line'>  <span class="nb">ServerSignature</span> <span class="k">Off</span>
</span><span class='line'>  <span class="nb">CustomLog</span> <span class="s2">&quot;/var/log/httpd/keystone_wsgi_admin_access.log&quot;</span> combined
</span><span class='line'>  <span class="nb">WSGIDaemonProcess</span> keystone_admin <span class="k">group</span>=keystone processes=1 threads=4 <span class="k">user</span>=keystone
</span><span class='line'>  <span class="nb">WSGIProcessGroup</span> keystone_admin
</span><span class='line'>  <span class="nb">WSGIScriptAlias</span> / <span class="s2">&quot;/var/www/keystone/admin&quot;</span>
</span><span class='line'><span class="nt">&lt;/VirtualHost&gt;</span>
</span></code></pre></td></tr></table></div></figure>

If you restart Apache with this configuration you should see keystone start up and run with no apparent difference.

There has been a push recently to stop using ports 5000 and 35357 when using apache and run them off the `/main` and `/admin` paths.
This will work just fine, however I&#8217;m trying to do this with as little overall change to the initial deployment, you may obviously set your deployment up to your own needs.

##Part 5 - Convert Keystone to LDAP:

First we create a keystone user.
This isn&#8217;t required in a typical deployment, however we need to provide a user with which to connect to the ldap server.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">ipa user-add --first keystone --last openstack --random keystone</span>
</span></code></pre></td></tr></table></div></figure>

`&#8211;random` sets a random password, you can omit it and set your own if you like.

Edit the `/etc/keystone/keystone.conf` file to use LDAP for the identity backend, and SQL for assignments.
This is the preferred deployment so whilst the users are in LDAP, projects and the permissions a user has on a project are managed in SQL.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[identity]</span>
</span><span class='line'><span class="na">driver</span> <span class="o">=</span> <span class="s">keystone.identity.backends.ldap.Identity</span>
</span><span class='line'>
</span><span class='line'><span class="k">[assignment]</span>
</span><span class='line'><span class="na">driver</span> <span class="o">=</span> <span class="s">keystone.assignment.backends.sql.Assignment</span>
</span></code></pre></td></tr></table></div></figure>

Still in `/etc/keystone/keystone.conf` we set the parameters for how to talk to the LDAP server that FreeIPA set up.
The password used here is the random one generated above.
You will need to replace the pattern `dc=test,dc=jamielennox,dc=net` with the similarly formatted realm that FreeIPA is configured for in your deployment.
This is the complete (comments removed) `[ldap]` section of the `keystone.conf` file.
This plus the `[identity]` block above are also exactly what would go into a [domain specific backend](http://docs.openstack.org/developer/keystone/configuration.html#domain-specific-drivers) configuration if you are deploying that way.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[ldap]</span>
</span><span class='line'><span class="na">url</span><span class="o">=</span><span class="s">ldaps://ipa.test.jamielennox.net</span>
</span><span class='line'><span class="na">user</span><span class="o">=</span><span class="s">uid=keystone,cn=users,cn=accounts,dc=test,dc=jamielennox,dc=net</span>
</span><span class='line'><span class="na">password</span><span class="o">=</span><span class="s">D@yFxU6SZHV_</span>
</span><span class='line'><span class="na">suffix</span><span class="o">=</span><span class="s">dc=test,dc=jamielennox,dc=net</span>
</span><span class='line'><span class="na">user_tree_dn</span><span class="o">=</span><span class="s">cn=users,cn=accounts,dc=test,dc=jamielennox,dc=net</span>
</span><span class='line'><span class="na">user_objectclass</span><span class="o">=</span><span class="s">person</span>
</span><span class='line'><span class="na">user_id_attribute</span><span class="o">=</span><span class="s">uid</span>
</span><span class='line'><span class="na">user_name_attribute</span><span class="o">=</span><span class="s">uid</span>
</span><span class='line'><span class="na">user_mail_attribute</span><span class="o">=</span><span class="s">mail</span>
</span><span class='line'><span class="na">user_allow_create</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">user_allow_update</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">user_allow_delete</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">group_tree_dn</span><span class="o">=</span><span class="s">cn=groups,cn=accounts,dc=test,dc=jamielennox,dc=net</span>
</span><span class='line'><span class="na">group_objectclass</span><span class="o">=</span><span class="s">groupOfNames</span>
</span><span class='line'><span class="na">group_id_attribute</span><span class="o">=</span><span class="s">cn</span>
</span><span class='line'><span class="na">group_name_attribute</span><span class="o">=</span><span class="s">cn</span>
</span><span class='line'><span class="na">group_member_attribute</span><span class="o">=</span><span class="s">member</span>
</span><span class='line'><span class="na">group_desc_attribute</span><span class="o">=</span><span class="s">description</span>
</span><span class='line'><span class="na">group_allow_create</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">group_allow_update</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">group_allow_delete</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">user_enabled_attribute</span><span class="o">=</span><span class="s">nsAccountLock</span>
</span><span class='line'><span class="na">user_enabled_default</span><span class="o">=</span><span class="s">False</span>
</span><span class='line'><span class="na">user_enabled_invert</span><span class="o">=</span><span class="s">true</span>
</span></code></pre></td></tr></table></div></figure>

Make sure to restart keystone (via apache) to set this configuration.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# systemctl restart httpd</span>
</span></code></pre></td></tr></table></div></figure>

##Part 6 - Recreate the LDAP users:

This is particularly hacky.
For my single domain deployment when I switch Keystone over to using the LDAP source it will loose access to the users that were set up via Packstack so I will need to recreate these users.
If you are using multiple domains you can skip this, leave the service users in the default domain and use your FreeIPA users via an alternative domain.

The easiest way I&#8217;ve found to do this is to remove the `[general]` tag at the top of the Packstack answers file that was created and then `source` it as bash environment variables.
This answers file is generally found in `/root/` and will be appended with a timestamp.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">[root@openstack]# sed -i -e &quot;s/\[general\]/#</span> <span class="o">[</span>general<span class="o">]</span>/<span class="err">&quot;</span> packstack-answers.txt
</span><span class='line'><span class="go">[root@openstack]# source packstack-answers.txt</span>
</span></code></pre></td></tr></table></div></figure>

Then install the admin tools to allow you to add users via command line and `kinit` as the `admin` user to have permission to add users.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# yum install -y ipa-admintools</span>
</span><span class='line'><span class="go">[root@openstack]# kinit admin</span>
</span></code></pre></td></tr></table></div></figure>

Then recreate those users, I&#8217;ll omit the shell prompt here so that it&#8217;s easier to copy and paste, but you could script this fairly easily.
We are creating a FreeIPA user for each of the services, setting a password for the user, and then assigning the user a role on the services project.

I&#8217;m using the admin token to assign the roles as there are no longer any valid users that I can use to assign these roles.

__NOTE__: This is a fairly unsafe way of creating these users in IPA as they are given full home and login permissions to any IPA machines.
In a real deployment these should be system users and ensure they aren&#8217;t able to login.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">export OS_ENDPOINT=http://localhost:35357/v2.0</span>
</span><span class='line'><span class="go">export OS_TOKEN=$CONFIG_KEYSTONE_ADMIN_TOKEN</span>
</span><span class='line'>
</span><span class='line'><span class="go">ipa user-add --first nova --last openstack nova &amp;&amp; echo $CONFIG_NOVA_KS_PW | ipa passwd nova</span>
</span><span class='line'><span class="go">keystone user-role-add --user nova --role admin --tenant services</span>
</span><span class='line'>
</span><span class='line'><span class="go">ipa user-add --first ceilometer --last openstack ceilometer &amp;&amp; echo $CONFIG_CEILOMETER_KS_PW | ipa passwd ceilometer</span>
</span><span class='line'><span class="go">keystone user-role-add --user ceilometer --role admin --tenant services</span>
</span><span class='line'>
</span><span class='line'><span class="go">ipa user-add --first cinder --last openstack cinder &amp;&amp; echo $CONFIG_CINDER_KS_PW | ipa passwd cinder</span>
</span><span class='line'><span class="go">keystone user-role-add --user cinder --role admin --tenant services</span>
</span><span class='line'>
</span><span class='line'><span class="go">ipa user-add --first glance --last openstack glance &amp;&amp; echo $CONFIG_GLANCE_KS_PW | ipa passwd glance</span>
</span><span class='line'><span class="go">keystone user-role-add --user glance --role admin --tenant services</span>
</span><span class='line'>
</span><span class='line'><span class="go">ipa user-add --first neutron --last openstack neutron &amp;&amp; echo $CONFIG_NEUTRON_KS_PW | ipa passwd neutron</span>
</span><span class='line'><span class="go">keystone user-role-add --user neutron --role admin --tenant services</span>
</span><span class='line'>
</span><span class='line'><span class="go">ipa user-add --first swift --last openstack swift &amp;&amp; echo $CONFIG_SWIFT_KS_PW | ipa passwd swift</span>
</span><span class='line'><span class="go">keystone user-role-add --user swift --role admin --tenant services</span>
</span></code></pre></td></tr></table></div></figure>

I add the keystone user to the services project as well - though in this case it won&#8217;t really matter.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">keystone user-role-add --user keystone --role admin --tenant services</span>
</span></code></pre></td></tr></table></div></figure>

Create the demo user and add the default roles to admin and demo so the `keystonerc_admin` and `keystonerc_demo` files still work as expected.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">ipa user-add --first demo --last openstack demo &amp;&amp; echo $CONFIG_KEYSTONE_DEMO_PW  | ipa passwd demo</span>
</span><span class='line'><span class="go">keystone user-role-add --user demo --role _member_ --tenant demo</span>
</span><span class='line'>
</span><span class='line'><span class="go">keystone user-role-add --user admin --role admin --tenant admin</span>
</span></code></pre></td></tr></table></div></figure>

##Part 7 - Kerberos:

Now we look to add Kerberos authentication.
First we have to register the service that you want to use on the IPA server.
For the current Kerberos plugin this _must_ be the HTTP service or the plugin won&#8217;t catch it.
Then we fetch the keytab and put it somewhere apache can access it.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# ipa service-add HTTP/openstack.test.jamielennox.net@TEST.JAMIELENNOX.NET</span>
</span><span class='line'><span class="go">[root@openstack]# ipa-getkeytab -s ipa.test.jamielennox.net -p HTTP/openstack.test.jamielennox.net@TEST.JAMIELENNOX.NET -k /etc/httpd/conf/httpd.keytab</span>
</span><span class='line'><span class="go">[root@openstack]# chown apache: /etc/httpd/conf/httpd.keytab</span>
</span></code></pre></td></tr></table></div></figure>

Install the `mod_auth_kerb` apache module which handles Kerberos Authentication, and enable it.
(Generally you don&#8217;t have to enable module, this looks like a pattern that packstack has established)

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# yum install -y mod_auth_kerb</span>
</span><span class='line'><span class="go">[root@openstack]# ln -s /etc/httpd/conf.modules.d/10-auth_kerb.conf /etc/httpd/conf.d/10-auth_kerb.load</span>
</span></code></pre></td></tr></table></div></figure>

Add the following snippet to _both_ the vhosts we created earlier, adjusting `/main` to `/admin` for the admin port.
The `WSGIScriptAlias / &#8220;/var/www/keystone/main&#8221;` is already present from the initial setup, this just shows that you need to insert the `/krb` reference _above_ it to make it take precedence.

This is creating a new route to the Keystone server code through which every access is Kerberos protected.
We will use this address later as our authentication URL.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nb">WSGIScriptAlias</span> <span class="sx">/krb</span> <span class="s2">&quot;/var/www/keystone/main&quot;</span>
</span><span class='line'><span class="nb">WSGIScriptAlias</span> / <span class="s2">&quot;/var/www/keystone/main&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;Location</span> <span class="s">&quot;/krb/v3/auth/tokens&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nb">LogLevel</span> <span class="k">debug</span>
</span><span class='line'>      <span class="nb">AuthType</span> Kerberos
</span><span class='line'>      <span class="nb">AuthName</span> <span class="s2">&quot;Kerberos Login&quot;</span>
</span><span class='line'>      <span class="nb">KrbMethodNegotiate</span> <span class="k">on</span>
</span><span class='line'>      <span class="nb">KrbMethodK5Passwd</span> <span class="k">off</span>
</span><span class='line'>      <span class="nb">KrbServiceName</span> HTTP
</span><span class='line'>      <span class="nb">KrbAuthRealms</span> TEST.JAMIELENNOX.NET
</span><span class='line'>      <span class="nb">Krb5KeyTab</span> <span class="sx">/etc/httpd/conf/httpd.keytab</span>
</span><span class='line'>      <span class="nb">KrbLocalUserMapping</span> <span class="k">on</span>
</span><span class='line'>      <span class="nb">Require</span> valid-user
</span><span class='line'>      <span class="nb">SetEnv</span> REMOTE_DOMAIN Default
</span><span class='line'><span class="nt">&lt;/Location&gt;</span>
</span></code></pre></td></tr></table></div></figure>

The SetEnv directive there is not required as we are deploying into the `Default` domain, however if you are deploying into a different domain you should set `REMOTE_DOMAIN` to the _name_ of the user&#8217;s domain.

Restart Apache.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# systemctl restart httpd</span>
</span></code></pre></td></tr></table></div></figure>

##Part 8 - Client:

Obviously you don&#8217;t have to run the client on the same machine as the server.
You can start up another machine here and do an `ipa-client-install` to initialize it for testing if you like, or put it on your own desktop (you can add your kerberos server to `/etc/krb5.conf` to not register it as a FreeIPA client).

Install the openstack command line tool

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# yum install -y python-openstackclient</span>
</span></code></pre></td></tr></table></div></figure>

We also want to install the Kerberos client plugin from source.
This plugin is imminently due for its first release on PyPI however it will take a while to get to packages.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# yum groupinstall &quot;Development Tools&quot;</span>
</span><span class='line'><span class="go">[root@openstack]# yum install -y krb5-devel</span>
</span><span class='line'><span class="go">[root@openstack]# git clone https://github.com/openstack/python-keystoneclient-kerberos.git /opt/python-keystoneclient-kerberos</span>
</span><span class='line'><span class="go">[root@openstack]# pip install -e /opt/python-keystoneclient-kerberos</span>
</span></code></pre></td></tr></table></div></figure>

Now `kinit` as the demo user to get a Kerberos ticket to test with.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">[root@openstack]# su centos  #</span> or another user
</span><span class='line'><span class="gp">[centos@openstack]$ echo $</span>CONFIG_KEYSTONE_DEMO_PW <span class="p">|</span> kinit demo
</span></code></pre></td></tr></table></div></figure>

Finally, for the dramatic finale, let&#8217;s get a token.
I&#8217;m putting the authentication parameters on the command line however they all exist as environment variables to create your own `keystonerc` file.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[centos@openstack]$ export OS_AUTH_URL=http://openstack.test.jamielennox.net:5000/krb/v3</span>
</span><span class='line'><span class="go">[centos@openstack]$ export OS_AUTH_TYPE=v3kerberos</span>
</span><span class='line'><span class="go">[centos@openstack]$ export OS_PROJECT_NAME=demo</span>
</span><span class='line'><span class="go">[centos@openstack]$ export OS_PROJECT_DOMAIN_ID=default</span>
</span><span class='line'><span class="go">[centos@openstack]$ openstack token issue</span>
</span></code></pre></td></tr></table></div></figure>

Notice the main authentication differences (and I&#8217;ll use the CLI equivalent for demonstration):

 - `&#8211;os-auth-url http://openstack.test.jamielennox.net:5000/krb/v3` we need to specify the v3 `auth-url` and include the `/krb` path so that the authentication request goes to the Kerberos route.
   Also because of the way your Kerberos ticket will be validated you have to use the full hostname as the url, even if you are calling from that box.
 - `&#8211;os-auth-type v3kerberos` which tells the CLI to use the kerberos plugin appropriate for the v3 API.
 - `&#8211;os-project-domain-id` because we are in the V3 API now so you need to specify the domain-id if you use `&#8211;os-project-name`

# Finish

Getting to the point where we can support the `openstack` command line tool has taken a lot of foundational work, and due to the independence of the clients it may be some time before the existing CLIs come to accept an authentication plugin parameter.
However now the foundation is in place I hope to see Kerberos becoming a more widely deployed authentication mechanism for OpenStack.

# Thanks

Special thanks have to go to:

 - [Jose Castro Leon](https://twitter.com/josecastroleon) and [Marek Dennis](https://twitter.com/marekdenis) from CERN who did the initial Kerberos implementation and have been pushing the approach.
 - [Nathan Kinder](https://blog-nkinder.rhcloud.com/) who [scripted a setup](https://github.com/nkinder/rdo-vm-factory/blob/master/rdo-kerberos-setup/vm-post-cloud-init-rdo.sh) that is more advanced and production worthy that I cheated off for a number of settings.
 - [Adam Young](http://adam.younglogic.com/) who started this whole Kerberos quest and who has stepped me through most of the above at least once.
]]></content>
  </entry>
  
</feed>
