<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Kerberos | jamielennox.net]]></title>
  <link href="http://www.jamielennox.net/blog/categories/kerberos/atom.xml" rel="self"/>
  <link href="http://www.jamielennox.net/"/>
  <updated>2016-10-05T16:44:31+11:00</updated>
  <id>http://www.jamielennox.net/</id>
  <author>
    <name><![CDATA[Jamie Lennox]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Setting Up S4u2proxy]]></title>
    <link href="http://www.jamielennox.net/blog/2015/02/27/setting-up-s4u2proxy/"/>
    <updated>2015-02-27T18:48:11+11:00</updated>
    <id>http://www.jamielennox.net/blog/2015/02/27/setting-up-s4u2proxy</id>
    <content type="html"><![CDATA[<h2>Motivation:</h2>

<p>Kerberos authentication provides a good experience for allowing users to connect to a service.
However this authentication does not allow the user to take the received ticket and further communicate with another service.</p>

<p>The canonical example of this is when authenticating to a web service we want to use the same user credentials to authenticate with an LDAP service, rather than require credentials for the service itself.</p>

<p>In my specific case if I have a <a href="http://www.jamielennox.net/blog/2015/02/12/step-by-step-kerberized-keystone/">kerberized keystone</a> then when the user talks to Horizon I want to forward the user&rsquo;s ticket to authenticate with keystone.</p>

<p>The mechanism that allows us to forward these Kerberos tickets is called Service-for-User-to-Proxy or S4U2Proxy.
To mitigate some of the security issues with delegating user tickets there are strict controls over which services are allowed to forward tickets and to whom which have to be configured.</p>

<p>For a more in-depth explanation check out the <a href="#furtherreading">further reading</a> section at the end of this post.</p>

<h2>Scenario:</h2>

<p>I intend this guide to be a step by step tutorial into setting up a basic S4U2 proxying service that we can verify and give you enough information to go about setting up more complex delegations.
If you are just looking for the raw commands you can jump down to <a href="#delegation">Setting up the Delegation</a>.</p>

<p>I created 3 Centos 7 virtual machines on a private network:</p>

<ul>
<li>An IPA server at <code>ipa.s4u2.jamielennox.net</code></li>
<li>A service provider at <code>service.s4u2.jamielennox.net</code> that will provide the target service.</li>
<li>An S4U2 proxy service at <code>proxy.s4u2.jamielennox.net</code> that will accept a Kerberos ticket and forward it to <code>service.s4u2.jamielennox.net</code></li>
</ul>


<p>For this setup I am creating a testing realm called <code>S4U2.JAMIELENNOX.NET</code>.
I will post the setup that works for my environment and leave it up to you to recognize where you should use your own service names.</p>

<h2>Setting up IPA</h2>

<pre><code>hostnamectl set-hostname ipa.s4u2.jamielennox.net
yum install -y ipa-server bind-dyndb-ldap
ipa-server-install
</code></pre>

<p>I pick the option to enable DNS as I think it&rsquo;s easier, you can skip that but then you&rsquo;ll need to make <code>/etc/hosts</code> entries for each of the hosts.</p>

<h2>Setting up the Service</h2>

<p>We start by doing the basic configuration of the machine and setting it up as an IPA client machine.</p>

<pre><code class="sh">hostnamectl set-hostname service.s4u2.jamielennox.net
yum install -y ipa-client
vim /etc/resolv.conf  # set DNS server to IPA IP address
ipa-client-install
yum install -y httpd php mod_auth_kerb
rm /etc/httpd/conf.d/welcome.conf  # a stub page that gets in the way
</code></pre>

<p>Register that we will be exposing a HTTP service on the machine:</p>

<pre><code class="sh">yum install -y ipa-admintools
kinit admin
ipa service-add HTTP/service.s4u2.jamielennox.net@S4U2.JAMIELENNOX.NET
</code></pre>

<p>Fetch the Kerberos keytab from IPA and make it accessible to Apache:</p>

<pre><code class="sh">ipa-getkeytab -s ipa.s4u2.jamielennox.net -p HTTP/service.s4u2.jamielennox.net@S4U2.JAMIELENNOX.NET -k /etc/httpd/conf/httpd.keytab
chown apache: /etc/httpd/conf/httpd.keytab
</code></pre>

<p>Create a simple site that will display the environment variables the server has received.
I share most people&rsquo;s opinion of PHP, however for a simple diagnostic site it&rsquo;s hard to beat <code>phpinfo()</code>:</p>

<pre><code>mkdir /var/www/s4u2
echo "&lt;?php phpinfo(); ?&gt;" &gt; /var/www/s4u2/index.php
</code></pre>

<p>Configure Apache to serve our simple PHP site behind Kerberos authentication.</p>

<p><figure class='code'><figcaption><span>/etc/httpd/conf.d/s4u2-service.conf </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nt">&lt;VirtualHost</span> <span class="s">*:80</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">ServerName</span> service.s4u2.jamielennox.net&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nb">DocumentRoot</span> &amp;ldquo;/var/www/s4u2&amp;rdquo;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;Directory</span> <span class="s">&quot;/var/www/s4u2&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nb">Options</span> Indexes FollowSymLinks MultiViews
</span><span class='line'>    <span class="nb">AllowOverride</span> <span class="k">None</span>
</span><span class='line'>    <span class="nb">Require</span> <span class="k">all</span> granted
</span><span class='line'>  <span class="nt">&lt;/Directory&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;Location</span> <span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nb">AuthType</span> Kerberos
</span><span class='line'>    <span class="nb">AuthName</span> &amp;ldquo;Kerberos Login&amp;rdquo;
</span><span class='line'>    <span class="nb">KrbMethodNegotiate</span> <span class="k">on</span>
</span><span class='line'>    <span class="nb">KrbMethodK5Passwd</span> <span class="k">off</span>
</span><span class='line'>    <span class="nb">KrbServiceName</span> HTTP
</span><span class='line'>    <span class="nb">KrbAuthRealms</span> S4U2.JAMIELENNOX.NET
</span><span class='line'>    <span class="nb">Krb5KeyTab</span> <span class="sx">/etc/httpd/conf/httpd.keytab</span>
</span><span class='line'>    <span class="nb">KrbSaveCredentials</span> <span class="k">on</span>
</span><span class='line'>    <span class="nb">KrbLocalUserMapping</span> <span class="k">on</span>
</span><span class='line'>    <span class="nb">Require</span> valid-user
</span><span class='line'>  <span class="nt">&lt;/Location&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nb">DirectoryIndex</span> index.php
</span><span class='line'><span class="nt">&lt;/VirtualHost&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Finally restart Apache to bring up the service site:</p>

<pre><code class="sh">systemctl restart httpd
</code></pre>

<h2>Setting up my local machine</h2>

<p>You could easily test all this using curl, however particularly as we are setting up HTTP to HTTP delegation the obvious use is going to be via the browser, so at this point I like to configure firefox to allow Kerberos negotiation.</p>

<p>I don&rsquo;t want my development machine to be an IPA client so I just configure the Kerberos KDC so that I can get a ticket on my machine with <code>kinit</code>.</p>

<p>Edit <code>/etc/krb5.conf</code> to add:</p>

<p><figure class='code'><figcaption><span>/etc/krb5.conf </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[realms]</span>
</span><span class='line'> <span class="na">S4U2.JAMIELENNOX.NET</span> <span class="o">=</span> <span class="s">{</span>
</span><span class='line'><span class="s">  kdc = ipa.s4u2.jamielennox.net</span>
</span><span class='line'><span class="s">  admin_server = ipa.s4u2.jamielennox.net</span>
</span><span class='line'><span class="s"> }&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span><span class="k">[domain_realms]</span>
</span><span class='line'> <span class="na">.s4u2.jamielennox.net</span> <span class="o">=</span> <span class="s">S4U2.JAMIELENNOX.NET</span>
</span><span class='line'><span class="s"> s4u2.jamielennox.net = S4U2.JAMIELENNOX.NET</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>And because I don&rsquo;t want to rely on the DNS provided by this IPA server I&rsquo;ll need to add the service IPs to <code>/etc/hosts</code>:</p>

<p><figure class='code'><figcaption><span>/etc/hosts </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>10.16.19.24     service.s4u2.jamielennox.net
</span><span class='line'>10.16.19.100    proxy.s4u2.jamielennox.net
</span><span class='line'>10.16.19.101    ipa.s4u2.jamielennox.net
</span></code></pre></td></tr></table></div></figure></p>

<p>In firefox open the config page (type <code>about:config</code> into the URL bar) and set:
<code>ini
network.negotiate-auth.delegation-uris = .s4u2.jamielennox.net
network.negotiate-auth.trusted-uris = .s4u2.jamielennox.net
</code>
These are comma seperated values so you can configure this in addition to any existing realms you might have configured.</p>

<p>To test get a ticket:
<code>sh
kinit admin@S4U2.JAMIELENNOX.NET
</code></p>

<p>I can now point firefox to <code>http://service.s4u2.jamielennox.net</code> and we see the <code>phpinfo()</code> dump of environment variables.
This means we have successfully set up our service host.</p>

<p>Interesting environment variables to check for to ensure this is correct are:</p>

<ul>
<li><code>REMOTE_USER admin</code> shows that the ticket belonged to the admin user.</li>
<li><code>AUTH_TYPE Negotiate</code> indicates that the user was authenticated via the Keberos mechanism.</li>
</ul>


<h2>Create Proxy Service</h2>

<p>When you register the service you have to mark it as allowed to delegate credentials.
You can do this anywhere you have an admin ticket or via the web UI, however there&rsquo;s less options to provide if you use one of the ipa client machines.</p>

<pre><code class="sh">ipa service-add HTTP/proxy.s4u2.jamielennox.net@S4U2.JAMIELENNOX.NET --ok-as-delegate=true
</code></pre>

<p>or to modify an existing service:
<code>sh
ipa service-mod HTTP/proxy.s4u2.jamielennox.net@S4U2.JAMIELENNOX.NET --ok-as-delegate=true
</code></p>

<h2><a name="delegation"></a>Setting up the Delegation</h2>

<p>Unfortunately FreeIPA has no way to manage S4U2 delegations via the command line or GUI yet and so we must resort to editing LDAP directly.
The s4u2 access permissions are defined from a group of services (<code>groupOfPrincipals</code>) onto a group of services.</p>

<p>You can see existing delegations via:</p>

<pre><code>ldapsearch -Y GSSAPI -H ldap://ipa.s4u2.jamielennox.net -b "cn=s4u2proxy,cn=etc,dc=s4u2,dc=jamielennox,dc=net" "" "*"
</code></pre>

<p>This delegation is how the FreeIPA web service is able to use the user&rsquo;s credentials to read and write from the LDAP server so there is at least 1 existing rule that you can copy from.</p>

<p>A delegation consists of two parts:</p>

<ul>
<li>A target group with a list of services (<code>memberPrincipal</code>) that are allowed to receive delegated credentials.</li>
<li>A group (type <code>objectclass=ipaKrb5DelegationACL</code>) with a list of services (<code>memberPrincipal</code>) that are allowed to delegate credentials <em>AND</em> the target groups (<code>ipaAllowedTarget</code>) that they can delegate to.</li>
</ul>


<p><figure class='code'><figcaption><span>delegate.ldif  </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;test-http-delegation-targets, s4u2proxy, etc, s4u2.jamielennox.net&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;dn: cn=test-http-delegation-targets,cn=s4u2proxy,cn=etc,dc=s4u2,dc=jamielennox,dc=net
</span><span class='line'>objectClass: groupOfPrincipals
</span><span class='line'>objectClass: top
</span><span class='line'>cn: test-http-delegation-targets
</span><span class='line'>memberPrincipal: HTTP/&lt;a href=&quot;&amp;#x6d;&amp;#x61;&amp;#x69;&amp;#x6c;&amp;#x74;&amp;#x6f;&amp;#58;&amp;#115;&amp;#101;&amp;#x72;&amp;#x76;&amp;#105;&amp;#99;&amp;#101;&amp;#46;&amp;#x73;&amp;#x34;&amp;#x75;&amp;#50;&amp;#46;&amp;#106;&amp;#97;&amp;#109;&amp;#105;&amp;#x65;&amp;#108;&amp;#x65;&amp;#x6e;&amp;#110;&amp;#111;&amp;#x78;&amp;#x2e;&amp;#x6e;&amp;#x65;&amp;#116;&amp;#x40;&amp;#83;&amp;#x34;&amp;#x55;&amp;#50;&amp;#46;&amp;#74;&amp;#65;&amp;#x4d;&amp;#x49;&amp;#69;&amp;#76;&amp;#69;&amp;#78;&amp;#x4e;&amp;#79;&amp;#88;&amp;#x2e;&amp;#78;&amp;#69;&amp;#84;&quot;&gt;&amp;#x73;&amp;#x65;&amp;#x72;&amp;#x76;&amp;#x69;&amp;#x63;&amp;#x65;&amp;#46;&amp;#115;&amp;#x34;&amp;#x75;&amp;#50;&amp;#46;&amp;#x6a;&amp;#97;&amp;#x6d;&amp;#x69;&amp;#x65;&amp;#108;&amp;#101;&amp;#x6e;&amp;#110;&amp;#111;&amp;#x78;&amp;#x2e;&amp;#x6e;&amp;#x65;&amp;#116;&amp;#x40;&amp;#x53;&amp;#x34;&amp;#85;&amp;#50;&amp;#46;&amp;#74;&amp;#x41;&amp;#x4d;&amp;#x49;&amp;#69;&amp;#x4c;&amp;#69;&amp;#x4e;&amp;#x4e;&amp;#x4f;&amp;#88;&amp;#46;&amp;#78;&amp;#69;&amp;#x54;&lt;/a&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;test-http-delegation, s4u2proxy, etc, s4u2.jamielennox.net&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;dn: cn=test-http-delegation,cn=s4u2proxy,cn=etc,dc=s4u2,dc=jamielennox,dc=net
</span><span class='line'>objectClass: ipaKrb5DelegationACL
</span><span class='line'>objectClass: groupOfPrincipals
</span><span class='line'>objectClass: top
</span><span class='line'>cn: test-http-delegation
</span><span class='line'>memberPrincipal: HTTP/&lt;a href=&quot;&amp;#109;&amp;#97;&amp;#105;&amp;#108;&amp;#x74;&amp;#111;&amp;#58;&amp;#112;&amp;#x72;&amp;#111;&amp;#x78;&amp;#x79;&amp;#x2e;&amp;#115;&amp;#x34;&amp;#117;&amp;#50;&amp;#x2e;&amp;#x6a;&amp;#x61;&amp;#x6d;&amp;#x69;&amp;#x65;&amp;#108;&amp;#101;&amp;#110;&amp;#x6e;&amp;#111;&amp;#120;&amp;#x2e;&amp;#x6e;&amp;#101;&amp;#x74;&amp;#64;&amp;#x53;&amp;#52;&amp;#85;&amp;#x32;&amp;#46;&amp;#x4a;&amp;#x41;&amp;#77;&amp;#73;&amp;#x45;&amp;#76;&amp;#69;&amp;#x4e;&amp;#78;&amp;#x4f;&amp;#88;&amp;#x2e;&amp;#78;&amp;#x45;&amp;#84;&quot;&gt;&amp;#112;&amp;#114;&amp;#x6f;&amp;#x78;&amp;#121;&amp;#x2e;&amp;#115;&amp;#52;&amp;#117;&amp;#50;&amp;#46;&amp;#x6a;&amp;#97;&amp;#109;&amp;#105;&amp;#x65;&amp;#x6c;&amp;#x65;&amp;#x6e;&amp;#110;&amp;#111;&amp;#x78;&amp;#46;&amp;#x6e;&amp;#x65;&amp;#x74;&amp;#64;&amp;#83;&amp;#x34;&amp;#x55;&amp;#50;&amp;#x2e;&amp;#x4a;&amp;#x41;&amp;#x4d;&amp;#73;&amp;#x45;&amp;#x4c;&amp;#69;&amp;#x4e;&amp;#x4e;&amp;#79;&amp;#88;&amp;#46;&amp;#78;&amp;#69;&amp;#x54;&lt;/a&gt;
</span><span class='line'>ipaAllowedTarget: cn=test-http-delegation-targets,cn=s4u2proxy,cn=etc,dc=s4u2,dc=jamielennox,dc=net
</span></code></pre></td></tr></table></div></figure></p>

<p>Write it to LDAP:</p>

<pre><code class="sh">ldapmodify -a -H ldaps://ipa.s4u2.jamielennox.net -Y GSSAPI -f delegate.ldif
</code></pre>

<p>And that&rsquo;s the hard work done, the <code>HTTP/proxy.s4u2.jamielennox.net@S4U2.JAMIELENNOX.NET</code> service now has permission to delegate a received ticket to <code>HTTP/service.s4u2.jamielennox.net@S4U2.JAMIELENNOX.NET</code>.</p>

<h2>Proxy</h2>

<p>Registering the proxy machine is very similar.</p>

<pre><code class="sh">hostnamectl set-hostname proxy.s4u2.jamielennox.net
yum install -y ipa-client
vim /etc/resolv.conf  # set DNS server to IPA IP address
setenforce 0
</code></pre>

<p>Because the easiest way I know to test a Kerberos endpoint is with curl I am also going to write the proxy service directly in bash:</p>

<p><figure class='code'><figcaption><span>/var/www/s4u2/index.sh </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;!/bin/sh&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;echo <span class="p">&amp;</span>ldquo<span class="p">;</span>Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8<span class="p">&amp;</span>rdquo<span class="p">;</span>
</span><span class='line'><span class="nb">echo</span> <span class="p">&amp;</span>ldquo<span class="p">;&amp;</span>rdquo<span class="p">;</span>
</span><span class='line'><span class="nb">echo</span> <span class="p">&amp;</span>ldquo<span class="p">;&amp;</span>rdquo<span class="p">;</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;simply dump the information from the service page&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;curl -s <span class="p">&amp;</span>ndash<span class="p">;</span>negotiate -u :  &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://service.s4u2.jamielennox.net&quot;</span>&gt;http://service.s4u2.jamielennox.net&lt;/a&gt;
</span></code></pre></td></tr></table></div></figure></p>

<p>This works because the cgi-bin sets the request environment into the shell environment, so <code>$KRB5CCNAME</code> is set.
If you are using mod_wsgi or other then you would have to set that into your shell environment before executing any Kerberos commands.</p>

<p>I&rsquo;m going to skip the IPA client setup and fetching the keytab - this is required and done exactly the same as for the service.</p>

<p>The apache configuration for the proxy is very similar to the configuration of the service except we add:</p>

<pre><code class="apache">KrbConstrainedDelegation on
</code></pre>

<p>Within the apache vhost config file to enable it to delegate a Kerberos credential.</p>

<p>The final config file looks like:</p>

<p><figure class='code'><figcaption><span>/etc/httpd/conf.d/s4u2-proxy.conf </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nt">&lt;VirtualHost</span> <span class="s">*:80</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">ServerName</span> proxy.s4u2.jamielennox.net&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nb">DocumentRoot</span> &amp;ldquo;/var/www/s4u2&amp;rdquo;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;Directory</span> <span class="s">&quot;/var/www/s4u2&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nb">Options</span> Indexes FollowSymLinks MultiViews ExecCGI
</span><span class='line'>    <span class="nb">AllowOverride</span> <span class="k">None</span>
</span><span class='line'>    <span class="nb">AddHandler</span> cgi-script .sh
</span><span class='line'>    <span class="nb">Require</span> <span class="k">all</span> granted
</span><span class='line'>  <span class="nt">&lt;/Directory&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;Location</span> <span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nb">AuthType</span> Kerberos
</span><span class='line'>    <span class="nb">AuthName</span> &amp;ldquo;Kerberos Login&amp;rdquo;
</span><span class='line'>    <span class="nb">KrbMethodNegotiate</span> <span class="k">on</span>
</span><span class='line'>    <span class="nb">KrbMethodK5Passwd</span> <span class="k">off</span>
</span><span class='line'>    <span class="nb">KrbServiceName</span> HTTP
</span><span class='line'>    <span class="nb">KrbAuthRealms</span> S4U2.JAMIELENNOX.NET
</span><span class='line'>    <span class="nb">Krb5KeyTab</span> <span class="sx">/etc/httpd/conf/httpd.keytab</span>
</span><span class='line'>    <span class="nb">KrbSaveCredentials</span> <span class="k">on</span>
</span><span class='line'>    <span class="nb">KrbLocalUserMapping</span> <span class="k">on</span>
</span><span class='line'>    <span class="nb">Require</span> valid-user
</span><span class='line'>    <span class="nb">KrbConstrainedDelegation</span> <span class="k">on</span>
</span><span class='line'>  <span class="nt">&lt;/Location&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nb">DirectoryIndex</span> index.sh
</span><span class='line'><span class="nt">&lt;/VirtualHost&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Restart apache to have your changes take effect:</p>

<pre><code class="sh">systemctl restart httpd
</code></pre>

<h2>Voila</h2>

<p>After all that aiming firefox at <code>http://proxy.s4u2.jamielennox.net</code> gives me the same <code>phpinfo</code> page I got from when I talked to the service host directly.
You can verify from this site also that the <code>SERVER\_NAME service.s4u2.jamielennox.net</code> and that <code>REMOTE_USER</code> is <code>admin</code>.</p>

<h2><a name="furtherreading"></a>Further Reading</h2>

<p>There are a couple of sites that this guide is based on:</p>

<ul>
<li><a href="http://adam.younglogic.com/2014/05/s4u2proxy-horizon/">Adam Young</a> - who initially prototyped a lot of the work for horizon which we hope to have ready soon.</li>
<li><a href="https://vda.li/en/posts/2013/07/29/Setting-up-S4U2Proxy-with-FreeIPA/">Alexander Bokovoy</a> - who is the actual authority that Adam and I are relying upon.</li>
<li><a href="https://ssimo.org/blog/id_011.html">Simo Sorce</a> - explaining the rationale and uses for the S4U2 delegation mechanisms.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Step-by-Step: Kerberized Keystone]]></title>
    <link href="http://www.jamielennox.net/blog/2015/02/12/step-by-step-kerberized-keystone/"/>
    <updated>2015-02-12T17:20:42+11:00</updated>
    <id>http://www.jamielennox.net/blog/2015/02/12/step-by-step-kerberized-keystone</id>
    <content type="html"><![CDATA[<p>Authentication plugins in Keystoneclient have gotten to the point where they are sufficiently well deployed that we can start to do interesting additional forms of authentication.
As Kerberos is a commonly requested authentication mechanism here is a simple, single domain keystone setup using Kerberos authentication.
They are not necessarily how you would setup a production deployment, but should give you the information you need to configure that yourself.</p>

<p>They create:</p>

<ul>
<li>A <a href="https://www.freeipa.org">FreeIPA</a> server machine called <code>ipa.test.jamielennox.net</code></li>
<li>A <a href="https://openstack.redhat.com/Quickstart">Packstack</a> all in one deployment of OpenStack called <code>openstack.test.jamielennox.net</code></li>
</ul>


<!-- more -->


<p>Notes:</p>

<ul>
<li>I use the realm <code>TEST.JAMIELENNOX.NET</code>. There is no meaning to this domain, it doesn&rsquo;t exist or make any difference to the deployment.</li>
<li>I am using a single domain deployment, so regular users and service users are intermingled.
There is no great benefit to this because the Kerberos plugin only supports the Keystone v3 API (so you have to be domain aware), however it a couple of steps.
Generally when doing a deployment like this I would put the IPA users in there own domain.</li>
</ul>


<p>Disclaimer:</p>

<ul>
<li>The goal of Kerberos authentication is obviously to enable both the command line and horizon interfaces to use your existing Kerberos ticket.
At the time of writing the <a href="http://docs.openstack.org/developer/python-openstackclient/">openstackclient</a> is really the only client capable of using plugins.
I am also <a href="https://review.openstack.org/#/c/153910/">working</a> <a href="https://review.openstack.org/#/c/153174/">on</a> the patches required to enable horizon for SSO.
There are obviously no promises that will be ready and accepted for the Kilo release, but I&rsquo;m hoping so.</li>
</ul>


<h2>Part 1 - Install FreeIPA</h2>

<p>From a brand new centos 7 image:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@ipa]# yum update -y</span>
</span><span class='line'><span class="go">[root@ipa]# hostnamectl set-hostname ipa.test.jamielennox.net</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Now install the FreeIPA server.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@ipa]# yum install ipa-server bind-dyndb-ldap -y</span>
</span><span class='line'><span class="go">[root@ipa]# ipa-server-install</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>I&rsquo;ve ignored the details here, generally having correctly set the hostname the defaults are correct for me, the only thing I generally do is opt to configuring bind for DNS.
This is the reason for installing <code>bind-dyndb-ldap</code> and you can skip it if you don&rsquo;t install bind, however you will need to edit your <code>/etc/hosts</code> file for the IPA server for the other machines as IPA relies on hostnames.</p>

<p>Pay particular attention to the username you give to the <code>admin</code> user as this user will be used from keystone later.
If you are unfamiliar with FreeIPA I suggest you test out the web interface, this is where your users will be registered.
As FreeIPA expects to be on a routable address you will need to add the hostname to <code>/etc/hosts</code> of the client machine to use the web service.</p>

<h2>Part 2 - Register as a FreeIPA Client</h2>

<p>The first thing I like to do is register the machine as a FreeIPA client machine.
After registering the machine comes available for us to fetch Kerberos tickets from (and SSL certs, etc).</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# yum update -y</span>
</span><span class='line'><span class="go">[root@openstack]# hostnamectl set-hostname openstack.test.jamielennox.net</span>
</span><span class='line'><span class="gp">[root@openstack]# vim /etc/resolv.conf  #</span> and update your DNS server IP of the ipa machine.
</span><span class='line'><span class="go">[root@openstack]# yum install ipa-client -y</span>
</span><span class='line'><span class="go">[root@openstack]# ipa-client-install</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Again, having correctly set a hostname and DNS server the default options are correct for me.
You&rsquo;ll need to provide the admin user and password from setting up the FreeIPA server.</p>

<h2>Part 3 - Install Packstack</h2>

<p>Packstack is a series of wrappers around the upstream puppet scripts that integrates well with RHEL/Centos, it will deploy the latest packaged version which is currently Juno.
You could use devstack or any alternative deployment here.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">[root@openstack]# setenforce 0  #</span> :<span class="o">(</span>
</span><span class='line'><span class="go">[root@openstack]# yum install -y &lt;a href=&quot;https://rdo.fedorapeople.org/rdo-release.rpm&quot;&gt;https://rdo.fedorapeople.org/rdo-release.rpm&lt;/a&gt;</span>
</span><span class='line'><span class="go">[root@openstack]# yum install -y openstack-packstack</span>
</span><span class='line'><span class="go">[root@openstack]# packstack &amp;ndash;allinone</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The <code>--allinone</code> option configures the entire OpenStack deployment on this machine, see <a href="https://openstack.redhat.com/Docs">the docs</a> for more detailed deployments methods.</p>

<h2>Part 4 - Convert Keystone to Apache</h2>

<p>To use kerberos authentication the keystone server uses the <code>mod_auth_kerb</code> Apache module. We therefore need to run the keystone server within Apache rather than from the script.
Ideally here we would have generated an answer file and told Packstack to use the <code>httpd</code> deployment method (which it can do) however this never seems to work for me, so I&rsquo;ll do it manually. YMMV.</p>

<p>Stop the existing keystone server and prevent it starting on boot:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# systemctl stop openstack-keystone</span>
</span><span class='line'><span class="go">[root@openstack]# systemctl disable openstack-keystone</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>There are many ways you could setup keystone within Apache. I don&rsquo;t think the <a href="http://docs.openstack.org/developer/keystone/apache-httpd.html">official docs</a> explain this very well but you can deploy it as you would any other <code>mod_wsgi</code> python site.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# mkdir /var/www/keystone</span>
</span><span class='line'><span class="go">[root@openstack]# ln -s /usr/share/keystone/keystone.wsgi /var/www/keystone/admin</span>
</span><span class='line'><span class="go">[root@openstack]# ln -s /usr/share/keystone/keystone.wsgi /var/www/keystone/main</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>This is the httpd config file I used initially:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nb">Listen</span> <span class="m">5000</span>
</span><span class='line'><span class="nb">Listen</span> <span class="m">35357</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;&lt;VirtualHost</span> <span class="s">*:5000</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">ServerName</span> openstack.test.jamielennox.net&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nb">DocumentRoot</span> &amp;ldquo;/var/www/keystone&amp;rdquo;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;Directory</span> <span class="s">&quot;/var/www/keystone&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nb">Options</span> Indexes FollowSymLinks MultiViews
</span><span class='line'>    <span class="nb">AllowOverride</span> <span class="k">None</span>
</span><span class='line'>    <span class="nb">Require</span> <span class="k">all</span> granted
</span><span class='line'>  <span class="nt">&lt;/Directory&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="c">## Logging</span>
</span><span class='line'>  <span class="nb">ErrorLog</span> &amp;ldquo;/var/log/httpd/keystone_wsgi_main_error.log&amp;rdquo;
</span><span class='line'>  <span class="nb">ServerSignature</span> <span class="k">Off</span>
</span><span class='line'>  <span class="nb">CustomLog</span> &amp;ldquo;/var/log/httpd/keystone_wsgi_main_access.log&amp;rdquo; combined
</span><span class='line'>  <span class="nb">WSGIDaemonProcess</span> keystone_main <span class="k">group</span>=keystone processes=1 threads=4 <span class="k">user</span>=keystone
</span><span class='line'>  <span class="nb">WSGIProcessGroup</span> keystone_main
</span><span class='line'>  <span class="nb">WSGIScriptAlias</span> / &amp;ldquo;/var/www/keystone/main&amp;rdquo;
</span><span class='line'><span class="nt">&lt;/VirtualHost&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;&lt;VirtualHost</span> <span class="s">*:35357</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nb">ServerName</span> openstack.test.jamielennox.net&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nb">DocumentRoot</span> &amp;ldquo;/var/www/keystone&amp;rdquo;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="nt">&lt;Directory</span> <span class="s">&quot;/var/www/keystone&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nb">Options</span> Indexes FollowSymLinks MultiViews
</span><span class='line'>    <span class="nb">AllowOverride</span> <span class="k">None</span>
</span><span class='line'>    <span class="nb">Require</span> <span class="k">all</span> granted
</span><span class='line'>  <span class="nt">&lt;/Directory&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>  <span class="c">## Logging</span>
</span><span class='line'>  <span class="nb">ErrorLog</span> &amp;ldquo;/var/log/httpd/keystone_wsgi_admin_error.log&amp;rdquo;
</span><span class='line'>  <span class="nb">ServerSignature</span> <span class="k">Off</span>
</span><span class='line'>  <span class="nb">CustomLog</span> &amp;ldquo;/var/log/httpd/keystone_wsgi_admin_access.log&amp;rdquo; combined
</span><span class='line'>  <span class="nb">WSGIDaemonProcess</span> keystone_admin <span class="k">group</span>=keystone processes=1 threads=4 <span class="k">user</span>=keystone
</span><span class='line'>  <span class="nb">WSGIProcessGroup</span> keystone_admin
</span><span class='line'>  <span class="nb">WSGIScriptAlias</span> / &amp;ldquo;/var/www/keystone/admin&amp;rdquo;
</span><span class='line'><span class="nt">&lt;/VirtualHost&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>If you restart Apache with this configuration you should see keystone start up and run with no apparent difference.</p>

<p>There has been a push recently to stop using ports 5000 and 35357 when using apache and run them off the <code>/main</code> and <code>/admin</code> paths.
This will work just fine, however I&rsquo;m trying to do this with as little overall change to the initial deployment, you may obviously set your deployment up to your own needs.</p>

<h2>Part 5 - Convert Keystone to LDAP:</h2>

<p>First we create a keystone user.
This isn&rsquo;t required in a typical deployment, however we need to provide a user with which to connect to the ldap server.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">ipa user-add &amp;ndash;first keystone &amp;ndash;last openstack &amp;ndash;random keystone</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><code>--random</code> sets a random password, you can omit it and set your own if you like.</p>

<p>Edit the <code>/etc/keystone/keystone.conf</code> file to use LDAP for the identity backend, and SQL for assignments.
This is the preferred deployment so whilst the users are in LDAP, projects and the permissions a user has on a project are managed in SQL.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[identity]</span>
</span><span class='line'><span class="na">driver</span> <span class="o">=</span> <span class="s">keystone.identity.backends.ldap.Identity&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;</span><span class="k">[assignment]</span>
</span><span class='line'><span class="na">driver</span> <span class="o">=</span> <span class="s">keystone.assignment.backends.sql.Assignment</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Still in <code>/etc/keystone/keystone.conf</code> we set the parameters for how to talk to the LDAP server that FreeIPA set up.
The password used here is the random one generated above.
You will need to replace the pattern <code>dc=test,dc=jamielennox,dc=net</code> with the similarly formatted realm that FreeIPA is configured for in your deployment.
This is the complete (comments removed) <code>[ldap]</code> section of the <code>keystone.conf</code> file.
This plus the <code>[identity]</code> block above are also exactly what would go into a <a href="http://docs.openstack.org/developer/keystone/configuration.html#domain-specific-drivers">domain specific backend</a> configuration if you are deploying that way.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[ldap]</span>
</span><span class='line'><span class="na">url</span><span class="o">=</span><span class="s">ldaps://ipa.test.jamielennox.net</span>
</span><span class='line'><span class="na">user</span><span class="o">=</span><span class="s">uid=keystone,cn=users,cn=accounts,dc=test,dc=jamielennox,dc=net</span>
</span><span class='line'><span class="na">password</span><span class="o">=</span><span class="s">D@yFxU6SZHV_</span>
</span><span class='line'><span class="na">suffix</span><span class="o">=</span><span class="s">dc=test,dc=jamielennox,dc=net</span>
</span><span class='line'><span class="na">user_tree_dn</span><span class="o">=</span><span class="s">cn=users,cn=accounts,dc=test,dc=jamielennox,dc=net</span>
</span><span class='line'><span class="na">user_objectclass</span><span class="o">=</span><span class="s">person</span>
</span><span class='line'><span class="na">user_id_attribute</span><span class="o">=</span><span class="s">uid</span>
</span><span class='line'><span class="na">user_name_attribute</span><span class="o">=</span><span class="s">uid</span>
</span><span class='line'><span class="na">user_mail_attribute</span><span class="o">=</span><span class="s">mail</span>
</span><span class='line'><span class="na">user_allow_create</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">user_allow_update</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">user_allow_delete</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">group_tree_dn</span><span class="o">=</span><span class="s">cn=groups,cn=accounts,dc=test,dc=jamielennox,dc=net</span>
</span><span class='line'><span class="na">group_objectclass</span><span class="o">=</span><span class="s">groupOfNames</span>
</span><span class='line'><span class="na">group_id_attribute</span><span class="o">=</span><span class="s">cn</span>
</span><span class='line'><span class="na">group_name_attribute</span><span class="o">=</span><span class="s">cn</span>
</span><span class='line'><span class="na">group_member_attribute</span><span class="o">=</span><span class="s">member</span>
</span><span class='line'><span class="na">group_desc_attribute</span><span class="o">=</span><span class="s">description</span>
</span><span class='line'><span class="na">group_allow_create</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">group_allow_update</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">group_allow_delete</span><span class="o">=</span><span class="s">false</span>
</span><span class='line'><span class="na">user_enabled_attribute</span><span class="o">=</span><span class="s">nsAccountLock</span>
</span><span class='line'><span class="na">user_enabled_default</span><span class="o">=</span><span class="s">False</span>
</span><span class='line'><span class="na">user_enabled_invert</span><span class="o">=</span><span class="s">true</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Make sure to restart keystone (via apache) to set this configuration.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# systemctl restart httpd</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>Part 6 - Recreate the LDAP users:</h2>

<p>This is particularly hacky.
For my single domain deployment when I switch Keystone over to using the LDAP source it will loose access to the users that were set up via Packstack so I will need to recreate these users.
If you are using multiple domains you can skip this, leave the service users in the default domain and use your FreeIPA users via an alternative domain.</p>

<p>The easiest way I&rsquo;ve found to do this is to remove the <code>[general]</code> tag at the top of the Packstack answers file that was created and then <code>source</code> it as bash environment variables.
This answers file is generally found in <code>/root/</code> and will be appended with a timestamp.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">[root@openstack]# sed -i -e &amp;ldquo;s/[general]/#</span> <span class="o">[</span>general<span class="o">]</span>/<span class="p">&amp;</span>rdquo<span class="p">;</span> packstack-answers.txt
</span><span class='line'><span class="go">[root@openstack]# source packstack-answers.txt</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Then install the admin tools to allow you to add users via command line and <code>kinit</code> as the <code>admin</code> user to have permission to add users.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# yum install -y ipa-admintools</span>
</span><span class='line'><span class="go">[root@openstack]# kinit admin</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Then recreate those users, I&rsquo;ll omit the shell prompt here so that it&rsquo;s easier to copy and paste, but you could script this fairly easily.
We are creating a FreeIPA user for each of the services, setting a password for the user, and then assigning the user a role on the services project.</p>

<p>I&rsquo;m using the admin token to assign the roles as there are no longer any valid users that I can use to assign these roles.</p>

<p><strong>NOTE</strong>: This is a fairly unsafe way of creating these users in IPA as they are given full home and login permissions to any IPA machines.
In a real deployment these should be system users and ensure they aren&rsquo;t able to login.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">export OS_ENDPOINT=&lt;a href=&quot;http://localhost:35357/v2.0&quot;&gt;http://localhost:35357/v2.0&lt;/a&gt;</span>
</span><span class='line'><span class="go">export OS_TOKEN=$CONFIG_KEYSTONE_ADMIN_TOKEN&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="go">&lt;p&gt;ipa user-add &amp;ndash;first nova &amp;ndash;last openstack nova &amp;amp;&amp;amp; echo $CONFIG_NOVA_KS_PW | ipa passwd nova</span>
</span><span class='line'><span class="go">keystone user-role-add &amp;ndash;user nova &amp;ndash;role admin &amp;ndash;tenant services&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="go">&lt;p&gt;ipa user-add &amp;ndash;first ceilometer &amp;ndash;last openstack ceilometer &amp;amp;&amp;amp; echo $CONFIG_CEILOMETER_KS_PW | ipa passwd ceilometer</span>
</span><span class='line'><span class="go">keystone user-role-add &amp;ndash;user ceilometer &amp;ndash;role admin &amp;ndash;tenant services&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="go">&lt;p&gt;ipa user-add &amp;ndash;first cinder &amp;ndash;last openstack cinder &amp;amp;&amp;amp; echo $CONFIG_CINDER_KS_PW | ipa passwd cinder</span>
</span><span class='line'><span class="go">keystone user-role-add &amp;ndash;user cinder &amp;ndash;role admin &amp;ndash;tenant services&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="go">&lt;p&gt;ipa user-add &amp;ndash;first glance &amp;ndash;last openstack glance &amp;amp;&amp;amp; echo $CONFIG_GLANCE_KS_PW | ipa passwd glance</span>
</span><span class='line'><span class="go">keystone user-role-add &amp;ndash;user glance &amp;ndash;role admin &amp;ndash;tenant services&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="go">&lt;p&gt;ipa user-add &amp;ndash;first neutron &amp;ndash;last openstack neutron &amp;amp;&amp;amp; echo $CONFIG_NEUTRON_KS_PW | ipa passwd neutron</span>
</span><span class='line'><span class="go">keystone user-role-add &amp;ndash;user neutron &amp;ndash;role admin &amp;ndash;tenant services&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="go">&lt;p&gt;ipa user-add &amp;ndash;first swift &amp;ndash;last openstack swift &amp;amp;&amp;amp; echo $CONFIG_SWIFT_KS_PW | ipa passwd swift</span>
</span><span class='line'><span class="go">keystone user-role-add &amp;ndash;user swift &amp;ndash;role admin &amp;ndash;tenant services</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>I add the keystone user to the services project as well - though in this case it won&rsquo;t really matter.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">keystone user-role-add &amp;ndash;user keystone &amp;ndash;role admin &amp;ndash;tenant services</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Create the demo user and add the default roles to admin and demo so the <code>keystonerc_admin</code> and <code>keystonerc_demo</code> files still work as expected.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">ipa user-add &amp;ndash;first demo &amp;ndash;last openstack demo &amp;amp;&amp;amp; echo $CONFIG_KEYSTONE_DEMO_PW  | ipa passwd demo</span>
</span><span class='line'><span class="go">keystone user-role-add &amp;ndash;user demo &amp;ndash;role &lt;em&gt;member&lt;/em&gt; &amp;ndash;tenant demo&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="go">&lt;p&gt;keystone user-role-add &amp;ndash;user admin &amp;ndash;role admin &amp;ndash;tenant admin</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>Part 7 - Kerberos:</h2>

<p>Now we look to add Kerberos authentication.
First we have to register the service that you want to use on the IPA server.
For the current Kerberos plugin this <em>must</em> be the HTTP service or the plugin won&rsquo;t catch it.
Then we fetch the keytab and put it somewhere apache can access it.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">[root@openstack]# ipa service-add HTTP/&lt;a href=&quot;&amp;#x6d;&amp;#x61;&amp;#105;&amp;#x6c;&amp;#116;&amp;#x6f;&amp;#x3a;&amp;#x6f;&amp;#112;&amp;#101;&amp;#x6e;&amp;#115;&amp;#x74;&amp;#x61;&amp;#99;&amp;#x6b;&amp;#46;&amp;#116;&amp;#101;&amp;#115;&amp;#x74;&amp;#x2e;&amp;#106;&amp;#97;&amp;#x6d;&amp;#105;&amp;#101;&amp;#x6c;&amp;#101;&amp;#110;&amp;#110;&amp;#111;&amp;#x78;&amp;#46;&amp;#x6e;&amp;#x65;&amp;#x74;&amp;#x40;&amp;#x54;&amp;#x45;&amp;#x53;&amp;#84;&amp;#x2e;&amp;#x4a;&amp;#x41;&amp;#x4d;&amp;#73;&amp;#69;&amp;#x4c;&amp;#69;&amp;#78;&amp;#78;&amp;#x4f;&amp;#x58;&amp;#46;&amp;#78;&amp;#x45;&amp;#84;&quot;&gt;&amp;#x6f;&amp;#112;&amp;#101;&amp;#x6e;&amp;#115;&amp;#116;&amp;#x61;&amp;#x63;&amp;#x6b;&amp;#46;&amp;#116;&amp;#101;&amp;#x73;&amp;#116;&amp;#x2e;&amp;#106;&amp;#x61;&amp;#109;&amp;#105;&amp;#x65;&amp;#108;&amp;#x65;&amp;#x6e;&amp;#x6e;&amp;#111;&amp;#120;&amp;#46;&amp;#110;&amp;#x65;&amp;#x74;&amp;#x40;&amp;#84;&amp;#x45;&amp;#x53;&amp;#84;&amp;#x2e;&amp;#x4a;&amp;#x41;&amp;#x4d;&amp;#x49;&amp;#69;&amp;#x4c;&amp;#x45;&amp;#x4e;&amp;#x4e;&amp;#79;&amp;#88;&amp;#46;&amp;#x4e;&amp;#69;&amp;#</span>x54<span class="p">;</span>&lt;/a&gt;
</span><span class='line'><span class="gp">[root@openstack]# ipa-getkeytab -s ipa.test.jamielennox.net -p HTTP/&lt;a href=&quot;&amp;#x6d;&amp;#x61;&amp;#105;&amp;#108;&amp;#x74;&amp;#x6f;&amp;#58;&amp;#111;&amp;#112;&amp;#101;&amp;#x6e;&amp;#115;&amp;#x74;&amp;#97;&amp;#99;&amp;#x6b;&amp;#46;&amp;#116;&amp;#101;&amp;#x73;&amp;#116;&amp;#x2e;&amp;#106;&amp;#x61;&amp;#x6d;&amp;#x69;&amp;#x65;&amp;#x6c;&amp;#101;&amp;#x6e;&amp;#x6e;&amp;#x6f;&amp;#x78;&amp;#x2e;&amp;#110;&amp;#101;&amp;#116;&amp;#64;&amp;#84;&amp;#69;&amp;#83;&amp;#x54;&amp;#x2e;&amp;#74;&amp;#65;&amp;#x4d;&amp;#x49;&amp;#69;&amp;#x4c;&amp;#x45;&amp;#x4e;&amp;#x4e;&amp;#79;&amp;#x58;&amp;#x2e;&amp;#x4e;&amp;#69;&amp;#84;&quot;&gt;&amp;#x6f;&amp;#112;&amp;#101;&amp;#110;&amp;#115;&amp;#x74;&amp;#x61;&amp;#99;&amp;#x6b;&amp;#46;&amp;#116;&amp;#101;&amp;#115;&amp;#x74;&amp;#x2e;&amp;#x6a;&amp;#x61;&amp;#x6d;&amp;#x69;&amp;#101;&amp;#x6c;&amp;#101;&amp;#x6e;&amp;#110;&amp;#111;&amp;#x78;&amp;#46;&amp;#x6e;&amp;#x65;&amp;#116;&amp;#x40;&amp;#84;&amp;#x45;&amp;#x53;&amp;#84;&amp;#x2e;&amp;#74;&amp;#x41;&amp;#x4d;&amp;#73;&amp;#x45;&amp;#x4c;&amp;#69;&amp;#78;&amp;#78;&amp;#x4f;&amp;#x58;&amp;#x2e;&amp;#x4e;&amp;#69;&amp;#</span>x54<span class="p">;</span>&lt;/a&gt; -k /etc/httpd/conf/httpd.keytab
</span><span class='line'><span class="go">[root@openstack]# chown apache: /etc/httpd/conf/httpd.keytab</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Install the <code>mod_auth_kerb</code> apache module which handles Kerberos Authentication, and enable it.
(Generally you don&rsquo;t have to enable module, this looks like a pattern that packstack has established)</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# yum install -y mod_auth_kerb</span>
</span><span class='line'><span class="go">[root@openstack]# ln -s /etc/httpd/conf.modules.d/10-auth_kerb.conf /etc/httpd/conf.d/10-auth_kerb.load</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Add the following snippet to <em>both</em> the vhosts we created earlier, adjusting <code>/main</code> to <code>/admin</code> for the admin port.
The <code>WSGIScriptAlias / "/var/www/keystone/main"</code> is already present from the initial setup, this just shows that you need to insert the <code>/krb</code> reference <em>above</em> it to make it take precedence.</p>

<p>This is creating a new route to the Keystone server code through which every access is Kerberos protected.
We will use this address later as our authentication URL.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='apache'><span class='line'><span class="nb">WSGIScriptAlias</span> <span class="sx">/krb</span> &amp;ldquo;/var/www/keystone/main&amp;rdquo;
</span><span class='line'><span class="nb">WSGIScriptAlias</span> / &amp;ldquo;/var/www/keystone/main&amp;rdquo;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;&lt;Location</span> <span class="s">&quot;/krb/v3/auth/tokens&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nb">LogLevel</span> <span class="k">debug</span>
</span><span class='line'>      <span class="nb">AuthType</span> Kerberos
</span><span class='line'>      <span class="nb">AuthName</span> &amp;ldquo;Kerberos Login&amp;rdquo;
</span><span class='line'>      <span class="nb">KrbMethodNegotiate</span> <span class="k">on</span>
</span><span class='line'>      <span class="nb">KrbMethodK5Passwd</span> <span class="k">off</span>
</span><span class='line'>      <span class="nb">KrbServiceName</span> HTTP
</span><span class='line'>      <span class="nb">KrbAuthRealms</span> TEST.JAMIELENNOX.NET
</span><span class='line'>      <span class="nb">Krb5KeyTab</span> <span class="sx">/etc/httpd/conf/httpd.keytab</span>
</span><span class='line'>      <span class="nb">KrbLocalUserMapping</span> <span class="k">on</span>
</span><span class='line'>      <span class="nb">Require</span> valid-user
</span><span class='line'>      <span class="nb">SetEnv</span> REMOTE_DOMAIN Default
</span><span class='line'><span class="nt">&lt;/Location&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The SetEnv directive there is not required as we are deploying into the <code>Default</code> domain, however if you are deploying into a different domain you should set <code>REMOTE_DOMAIN</code> to the <em>name</em> of the user&rsquo;s domain.</p>

<p>Restart Apache.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# systemctl restart httpd</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>Part 8 - Client:</h2>

<p>Obviously you don&rsquo;t have to run the client on the same machine as the server.
You can start up another machine here and do an <code>ipa-client-install</code> to initialize it for testing if you like, or put it on your own desktop (you can add your kerberos server to <code>/etc/krb5.conf</code> to not register it as a FreeIPA client).</p>

<p>Install the openstack command line tool</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# yum install -y python-openstackclient</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>We also want to install the Kerberos client plugin from source.
This plugin is imminently due for its first release on PyPI however it will take a while to get to packages.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[root@openstack]# yum groupinstall &amp;ldquo;Development Tools&amp;rdquo;</span>
</span><span class='line'><span class="go">[root@openstack]# yum install -y krb5-devel</span>
</span><span class='line'><span class="go">[root@openstack]# git clone &lt;a href=&quot;https://github.com/openstack/python-keystoneclient-kerberos.git&quot;&gt;https://github.com/openstack/python-keystoneclient-kerberos.git&lt;/a&gt; /opt/python-keystoneclient-kerberos</span>
</span><span class='line'><span class="go">[root@openstack]# pip install -e /opt/python-keystoneclient-kerberos</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Now <code>kinit</code> as the demo user to get a Kerberos ticket to test with.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="gp">[root@openstack]# su centos  #</span> or another user
</span><span class='line'><span class="gp">[centos@openstack]$ echo $</span>CONFIG_KEYSTONE_DEMO_PW <span class="p">|</span> kinit demo
</span></code></pre></td></tr></table></div></figure></p>

<p>Finally, for the dramatic finale, let&rsquo;s get a token.
I&rsquo;m putting the authentication parameters on the command line however they all exist as environment variables to create your own <code>keystonerc</code> file.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='console'><span class='line'><span class="go">[centos@openstack]$ export OS_AUTH_URL=&lt;a href=&quot;http://openstack.test.jamielennox.net:5000/krb/v3&quot;&gt;http://openstack.test.jamielennox.net:5000/krb/v3&lt;/a&gt;</span>
</span><span class='line'><span class="go">[centos@openstack]$ export OS_AUTH_TYPE=v3kerberos</span>
</span><span class='line'><span class="go">[centos@openstack]$ export OS_PROJECT_NAME=demo</span>
</span><span class='line'><span class="go">[centos@openstack]$ export OS_PROJECT_DOMAIN_ID=default</span>
</span><span class='line'><span class="go">[centos@openstack]$ openstack token issue</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Notice the main authentication differences (and I&rsquo;ll use the CLI equivalent for demonstration):</p>

<ul>
<li><code>--os-auth-url http://openstack.test.jamielennox.net:5000/krb/v3</code> we need to specify the v3 <code>auth-url</code> and include the <code>/krb</code> path so that the authentication request goes to the Kerberos route.
Also because of the way your Kerberos ticket will be validated you have to use the full hostname as the url, even if you are calling from that box.</li>
<li><code>--os-auth-type v3kerberos</code> which tells the CLI to use the kerberos plugin appropriate for the v3 API.</li>
<li><code>--os-project-domain-id</code> because we are in the V3 API now so you need to specify the domain-id if you use <code>--os-project-name</code></li>
</ul>


<h1>Finish</h1>

<p>Getting to the point where we can support the <code>openstack</code> command line tool has taken a lot of foundational work, and due to the independence of the clients it may be some time before the existing CLIs come to accept an authentication plugin parameter.
However now the foundation is in place I hope to see Kerberos becoming a more widely deployed authentication mechanism for OpenStack.</p>

<h1>Thanks</h1>

<p>Special thanks have to go to:</p>

<ul>
<li><a href="https://twitter.com/josecastroleon">Jose Castro Leon</a> and <a href="https://twitter.com/marekdenis">Marek Dennis</a> from CERN who did the initial Kerberos implementation and have been pushing the approach.</li>
<li><a href="https://blog-nkinder.rhcloud.com/">Nathan Kinder</a> who <a href="https://github.com/nkinder/rdo-vm-factory/blob/master/rdo-kerberos-setup/vm-post-cloud-init-rdo.sh">scripted a setup</a> that is more advanced and production worthy that I cheated off for a number of settings.</li>
<li><a href="http://adam.younglogic.com/">Adam Young</a> who started this whole Kerberos quest and who has stepped me through most of the above at least once.</li>
</ul>

]]></content>
  </entry>
  
</feed>
