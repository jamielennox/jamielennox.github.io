<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Python | jamielennox.net]]></title>
  <link href="http://www.jamielennox.net/blog/categories/python/atom.xml" rel="self"/>
  <link href="http://www.jamielennox.net/"/>
  <updated>2015-02-23T11:05:27+11:00</updated>
  <id>http://www.jamielennox.net/</id>
  <author>
    <name><![CDATA[Jamie Lennox]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Requests-mock]]></title>
    <link href="http://www.jamielennox.net/blog/2014/08/26/requests-mock/"/>
    <updated>2014-08-26T12:26:23+10:00</updated>
    <id>http://www.jamielennox.net/blog/2014/08/26/requests-mock</id>
    <content type="html"><![CDATA[Having just release v0.5 of [requests-mock](https://pypi.python.org/pypi/requests-mock) and having it used by both keystoneclient and novaclient with others in the works I thought I'd finally do a post explaining what it is and how to use it.

Motivation
----------

I was the person who brought [HTTPretty](http://falcao.it/HTTPretty/) into the OpenStack requirements.

The initial reason for this was that keystoneclient was transitioning from the [httplib](https://docs.python.org/2/library/httplib.html) library to [requests](http://docs.python-requests.org/en/latest/) and I needed to prove that there was no changes to the HTTP requests during the transition.
HTTPretty is a way to mock HTTP responses at the socket level, so it is not dependant on the HTTP library you use and for this it was fairly successful.

As part of that transition I converted all the unit tests so that they actually traversed through to the requesting layer and found a number of edge case bugs because the responses were being mocked out above this point.
I have therefore advocated that the clients convert to mocking at the request layer rather than stubbing out returned values.
I'm pretty sure that this doesn't adhere strictly to the unit testing philosophy of testing small isolated changes, but our client libraries aren't that deep and I'd honestly prefer to just test the whole way through and find those edge cases.

Having done this has made it remarkably easier to transition to using sessions in the clients as well, because we are testing the whole path down to making HTTP requests for all the resource tests so again have assurances that the HTTP requests being sent are equivalent.

At the same time we've had a number of problems with HTTPretty:

 - It was the lingering last requirement for getting Python 3 support. Thanks to Cyril Roelandt for finally getting that fixed.
 - For various reasons it is difficult for the distributions to package.
 - It has a bad habit of doing backwards incompatible, or simply broken releases. The current requirements string is: `httpretty>=0.8.0,!=0.8.1,!=0.8.2,!=0.8.3`
 - Because it acts at the socket layer it doesn&#8217;t always play nicely with other things using the socket. For example it has to be disabled for live memcache tests.
 - It pins its requirements on pypi.

Now I feel like I&#8217;m just ranting.
There are additional oddities I found in trying to fix these upstream but this is not about bashing HTTPretty.

requests-mock
&#8212;&#8212;&#8212;&#8212;-

requests-mock follows the same concepts allowing users to stub out responses to HTTP requests, however it specifically targets the requests library rather than stubbing the socket.
All the OpenStack clients have been converted to requests at this point, and for the general audience if you are writing HTTP code in Python you should be using requests.

Note: a lot of what is used in these examples is only available since the 0.5 release.
The current OpenStack requirements still have 0.4 so you&#8217;ll need to wait for some of the new syntax.

The intention of requests-mock is to work in as similar way to requests itself as possible.
Hence all the variable names and conventions should be as close to a `requests.Response` as possible.
For example:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">requests_mock</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://www.google.com&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">requests_mock</span><span class="o">.</span><span class="n">mock</span><span class="p">()</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&#39;Not really google&#39;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">218</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>     <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'><span class="s">u&#39;Not really google&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span>
</span><span class='line'><span class="mi">218</span>
</span></code></pre></td></tr></table></div></figure>

So `text` in the mock equates to `text` in the response and similarly for `status_code`.
Some more advanced usage of the requests library:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">requests_mock</span><span class="o">.</span><span class="n">mock</span><span class="p">()</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;hello&#39;</span><span class="p">:</span> <span class="s">&#39;world&#39;</span><span class="p">},</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;test&#39;</span><span class="p">:</span> <span class="s">&#39;header&#39;</span><span class="p">})</span>
</span><span class='line'><span class="o">...</span>     <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>
</span><span class='line'><span class="s">u&#39;{&quot;hello&quot;: &quot;world&quot;}&#39;</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;hello&#39;</span><span class="p">:</span> <span class="s">u&#39;world&#39;</span><span class="p">}</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span>
</span><span class='line'><span class="mi">200</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span>
</span><span class='line'><span class="p">{</span><span class="s">&#39;test&#39;</span><span class="p">:</span> <span class="s">&#39;header&#39;</span><span class="p">}</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;test&#39;</span><span class="p">]</span>
</span><span class='line'><span class="s">&#39;header&#39;</span>
</span></code></pre></td></tr></table></div></figure>

You can also use callbacks to create responses dynamically:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">_request_callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
</span><span class='line'><span class="o">...</span>     <span class="n">context</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">201</span>
</span><span class='line'><span class="o">...</span>     <span class="n">context</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;header&#39;</span>
</span><span class='line'><span class="o">...</span>     <span class="k">return</span> <span class="p">{</span><span class="s">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">}</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">with</span> <span class="n">requests_mock</span><span class="o">.</span><span class="n">mock</span><span class="p">()</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
</span><span class='line'><span class="o">...</span>     <span class="n">m</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">_request_callback</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>     <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s">&#39;data&#39;</span><span class="p">)</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span>
</span><span class='line'><span class="mi">201</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">headers</span>
</span><span class='line'><span class="p">{</span><span class="s">&#39;test&#39;</span><span class="p">:</span> <span class="s">&#39;header&#39;</span><span class="p">}</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span><span class="s">u&#39;request&#39;</span><span class="p">:</span> <span class="s">u&#39;data&#39;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

Note that because the callback was passed as the `json` parameter the return type is expected to be the same as if you had passed it as a predefined `json=blob` value.
If you wanted to return `text` the callback would be on the `text` parameter.

Cool tricks
&#8212;&#8212;&#8212;&#8211;

So rather than give a lot of examples i&#8217;ll just highlight some of the interesting things you can do with the library and how to do it.

 - Queue mutliple responses for a url, each element of the list is interpreted as if they were `**kwargs` for a response.
   In this case every request other than the first will get a 401 error:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">[{</span><span class="s">&#39;json&#39;</span><span class="p">:</span> <span class="n">_request_callback</span><span class="p">},</span>
</span><span class='line'>            <span class="p">{</span><span class="s">&#39;text&#39;</span><span class="p">:</span> <span class="s">&#39;Not Allowed&#39;</span><span class="p">,</span> <span class="s">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">401</span><span class="p">}])</span>
</span></code></pre></td></tr></table></div></figure>

 - See the history of requests:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">m</span><span class="o">.</span><span class="n">request_history</span>  <span class="c"># all requests</span>
</span><span class='line'><span class="n">m</span><span class="o">.</span><span class="n">last_request</span>  <span class="c"># the last request</span>
</span><span class='line'><span class="n">m</span><span class="o">.</span><span class="n">call_count</span>  <span class="c"># number of requests</span>
</span><span class='line'><span class="n">m</span><span class="o">.</span><span class="n">called</span>  <span class="c"># boolean, True if called</span>
</span></code></pre></td></tr></table></div></figure>

 - match on the only the URL path:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;/path/only&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

 - match on any method:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">m</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">requests_mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

 - or match on any URL:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">requests_mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

 - match on headers that are part of the request (useful for distinguishing between multiple requests to the same URL):

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">request_headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;X-Auth-Token&#39;</span><span class="p">:</span> <span class="s">&#39;XXXXX&#39;</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>

 - be used as a function decorator

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="nd">@requests_mock.mock</span><span class="p">()</span>
</span><span class='line'><span class="k">def</span> <span class="nf">test_a_thing</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span><span class='line'>   <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">requests_mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&#39;resp&#39;</span><span class="p">)</span>
</span><span class='line'>   <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>

Try it!
&#8212;&#8212;-

There is a lot more it can do and if you want to know more you can check out:

 - [Read the Docs](http://requests-mock.readthedocs.org/)
 - [PyPi](https://pypi.python.org/pypi/requests-mock)
 - [git repository](https://git.openstack.org/cgit/stackforge/requests-mock)

As a final selling point because it was built particularly around OpenStack needs it is:

 - Easily integrated with the [fixtures](https://pypi.python.org/pypi/fixtures) library.
 - Hosted on stackforge and reviewed via [Gerrit](https://review.openstack.org/#/q/project:stackforge/requests-mock+is:open,n,z).
 - Continuously tested against at least keystoneclient and novaclient to prevent backwards incompatible changes.
 - Accepted as part of OpenStack requirements.

Patches and [bug reports](https://bugs.launchpad.net/requests-mock) are welcome.
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Dealing With .pyc]]></title>
    <link href="http://www.jamielennox.net/blog/2014/02/18/dealing-with-pyc/"/>
    <updated>2014-02-18T11:08:00+11:00</updated>
    <id>http://www.jamielennox.net/blog/2014/02/18/dealing-with-pyc</id>
    <content type="html"><![CDATA[I have often found that when dealing with multiple branches and refactoring patches I get caught out by left over \*.pyc files from python files that don't exist on this branch.
This bit me again recently so I went looking for options.

A useful environment variable that I found via some stackoverflow questions is: [PYTHONDONTWRITEBYTECODE](http://docs.python.org/2/using/cmdline.html#envvar-PYTHONDONTWRITEBYTECODE) which, when set, prevents python from writing .pyc and .pyo files.
This is not something that I want to set permanently on my machine but is great for development.

The other tool I use for all my python projects is [virtualenvwrapper](http://virtualenvwrapper.readthedocs.org/en/latest/) which allows you to isolate project dependencies and environments in what I think is a more intuitive way than with virtualenv directly.

Armed with the simple idea that these two concepts should be able to work together I found I was not the first person to think of this.
There are other guides out there but the basic concept is simply to set PYTHONDONTWRITEBYTECODE when we activate a virtualenv and reset it when we deactivate it.

Easy.

Add to *~/.virtualenvs/postactivate*:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">_PYTHONDONTWRITEBYTECODE</span><span class="o">=</span><span class="nv">$PYTHONDONTWRITEBYTECODE</span>
</span><span class='line'><span class="nb">export </span><span class="nv">PYTHONDONTWRITEBYTECODE</span><span class="o">=</span>1
</span></code></pre></td></tr></table></div></figure>

Add to *~/.virtualenvs/predeactivate*:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">PYTHONDONTWRITEBYTECODE</span><span class="o">=</span><span class="nv">$_PYTHONDONTWRITEBYTECODE</span>
</span><span class='line'><span class="nb">unset </span>_PYTHONDONTWRITEBYETCODE
</span></code></pre></td></tr></table></div></figure>
]]></content>
  </entry>
  
</feed>
