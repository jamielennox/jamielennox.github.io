<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Keystone | jamielennox.net]]></title>
  <link href="http://www.jamielennox.net/blog/categories/keystone/atom.xml" rel="self"/>
  <link href="http://www.jamielennox.net/"/>
  <updated>2015-02-23T11:05:27+11:00</updated>
  <id>http://www.jamielennox.net/</id>
  <author>
    <name><![CDATA[Jamie Lennox]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[V3 Authentication With Auth_token Middleware]]></title>
    <link href="http://www.jamielennox.net/blog/2015/02/23/v3-authentication-with-auth-token-middleware/"/>
    <updated>2015-02-23T10:57:46+11:00</updated>
    <id>http://www.jamielennox.net/blog/2015/02/23/v3-authentication-with-auth-token-middleware</id>
    <content type="html"><![CDATA[Auth\_token is the middleware piece in OpenStack responsible for validating tokens and passing authentication and authorization information down to the services.
It has been a long time complaint of those wishing to move to the V3 identity API that auth\_token only supported the v2 API for authentication.

Then auth\_token middleware adopted authentication plugins and the people rejoiced!

Or it went by almost completely unnoticed.
Auth is not an area people like to mess with once it's working and people are still coming to terms with configuring via plugins.

The benefit of authentication plugins is that it allows you to use [any plugin you like for authentication](/blog/2015/02/17/loading-authentication-plugins/) - including the v3 plugins.
A downside is that being able to load any plugin means that there isn't the same set of default options present in the sample config files that would indicate the new options available for setting.
Particularly as we have to keep the old options around for compatibility.

The most common configuration I expect for v3 authentication with auth\_token middleware is:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[keystone_authtoken]</span>
</span><span class='line'><span class="na">auth_uri</span> <span class="o">=</span> <span class="s">https://public.keystone.uri:5000/</span>
</span><span class='line'><span class="na">cafile</span> <span class="o">=</span> <span class="s">/path/to/cas</span>
</span><span class='line'>
</span><span class='line'><span class="na">auth_plugin</span> <span class="o">=</span> <span class="s">password</span>
</span><span class='line'><span class="na">auth_url</span> <span class="o">=</span> <span class="s">http://internal.keystone.uri:35357/</span>
</span><span class='line'><span class="na">username</span> <span class="o">=</span> <span class="s">service</span>
</span><span class='line'><span class="na">password</span> <span class="o">=</span> <span class="s">service_pass</span>
</span><span class='line'><span class="na">user_domain_name</span> <span class="o">=</span> <span class="s">service_domain</span>
</span><span class='line'><span class="na">project_name</span> <span class="o">=</span> <span class="s">project</span>
</span><span class='line'><span class="na">project_domain_name</span> <span class="o">=</span> <span class="s">service_domain</span>
</span></code></pre></td></tr></table></div></figure>

The `password` plugin will query the `auth_url` for supported API versions and then use either v2 or v3 auth depending on what parameters you&#8217;ve specified.
If you want to save a round trip (once on startup) you can use the `v3password` plugin which takes the same parameters but requires a V3 URL to be specified in `auth_url`.

An unfortunate thing we&#8217;ve noticed from this is that there is going to be some confusion as most plugins present an `auth_url` parameter (used by the plugin to know where to authenticate the service user) along with the existing `auth_uri` parameter (reported in the headers of 403 responses to tell users where to authenticate).
This is a known issue we need to address and will likely result in changing the name of the `auth_uri` parameter as the concept of an `auth_url` is used by all existing clients and plugins.

For further proof that this works as expected checkout [devstack](https://github.com/openstack-dev/devstack/blob/5ce44cd63b6e2b53f08a6b4b87cb4ab11d1ade26/lib/keystone#L448) which has been operating this way for a couple of weeks.


_NOTE:_ Support for authentication plugins was released in keystonemiddleware 1.3.0 released 2014-12-18.
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Loading Authentication Plugins]]></title>
    <link href="http://www.jamielennox.net/blog/2015/02/17/loading-authentication-plugins/"/>
    <updated>2015-02-17T09:08:03+11:00</updated>
    <id>http://www.jamielennox.net/blog/2015/02/17/loading-authentication-plugins</id>
    <content type="html"><![CDATA[I've been pushing a lot on the authentication plugins aspect of keystoneclient recently.
They allow us to generalize the process of getting a token from OpenStack such that we can enable new mechanisms like [Kerberos](https://github.com/openstack/python-keystoneclient-kerberos) or client certificate authentication - without having to modify all the clients.

For most people hardcoding credentials into scripts is not an option, both for security and for reusability reasons.
By having a standard loading mechanism for this selection of new plugins we can ensure that applications we write can be used with future plugins.
I am currently working on getting this method into the existing services to allow for more extensible service authentication, so this pattern should become more common in future.

There are two loading mechanisms for authentication plugins provided by keystoneclient:

 - Loading from an [oslo.config](http://docs.openstack.org/developer/oslo.config) CONF object.
 - Loading from an [argparse](https://docs.python.org/2/library/argparse.html) command line

## Loading from CONF

We can define a plugin from CONF like:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[somegroup]</span>
</span><span class='line'><span class="na">auth_plugin</span> <span class="o">=</span> <span class="s">v3password</span>
</span><span class='line'><span class="na">auth_url</span> <span class="o">=</span> <span class="s">http://keystone.test:5000/v3</span>
</span><span class='line'><span class="na">username</span> <span class="o">=</span> <span class="s">user</span>
</span><span class='line'><span class="na">password</span> <span class="o">=</span> <span class="s">pass</span>
</span><span class='line'><span class="na">user_domain_name</span> <span class="o">=</span> <span class="s">domain</span>
</span><span class='line'><span class="na">project_name</span> <span class="o">=</span> <span class="s">proj</span>
</span><span class='line'><span class="na">project_domain_name</span> <span class="o">=</span> <span class="s">domain</span>
</span></code></pre></td></tr></table></div></figure>

The initially required field here is `auth_plugin` which specifies the name of the plugin to load.
All other parameters in that section are dependant on the information that plugin (in this case v3password) requires.

To load that plugin from an application we do:

<div><script src='https://gist.github.com/3b26bfb8e80fa48133e9.js?file=test-conf.py'></script>
<noscript><pre><code>import sys

from keystoneclient import auth
from keystoneclient import session
from oslo.config import cfg

cfg.CONF(sys.argv[1:])

auth.register_conf_options(cfg.CONF, 'somegroup')
session.Session.register_conf_options(cfg.CONF, 'somegroup')

plugin = auth.load_from_conf_options(cfg.CONF, 'somegroup')
sess = session.Session.load_from_conf_options(cfg.CONF,
                                              'somegroup',
                                              auth=plugin)
</code></pre></noscript></div>


Then create `novaclient`, `cinderclient` or whichever client you wish to talk to with that session as normal.

You can also use an `auth_section` parameter to specify a different group in which the authentication credentials are stored.
This allows you to reuse the same credentials in multiple places throughout your configuration file without copying and pasting.

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[somegroup]</span>
</span><span class='line'><span class="na">auth_section</span> <span class="o">=</span> <span class="s">credentials</span>
</span><span class='line'>
</span><span class='line'><span class="k">[othergroup]</span>
</span><span class='line'><span class="na">auth_section</span> <span class="o">=</span> <span class="s">credentials</span>
</span><span class='line'>
</span><span class='line'><span class="k">[credentials]</span>
</span><span class='line'><span class="na">auth_plugin</span> <span class="o">=</span> <span class="s">v3password</span>
</span><span class='line'><span class="na">auth_url</span> <span class="o">=</span> <span class="s">http://keystone.test:5000/v3</span>
</span><span class='line'><span class="na">username</span> <span class="o">=</span> <span class="s">user</span>
</span><span class='line'><span class="na">password</span> <span class="o">=</span> <span class="s">pass</span>
</span><span class='line'><span class="na">user_domain_name</span> <span class="o">=</span> <span class="s">domain</span>
</span><span class='line'><span class="na">project_name</span> <span class="o">=</span> <span class="s">proj</span>
</span><span class='line'><span class="na">project_domain_name</span> <span class="o">=</span> <span class="s">domain</span>
</span></code></pre></td></tr></table></div></figure>

The above loading code for `[somegroup]` or `[othergroup]` will load separate instances of the same authentication plugin.


## Loading from the command line

The options present on the command line are very similar to that presented via the config file, and follow a pattern familiar to the existing openstack CLI applications.
The equivalent options as specified in the config above would be presented as:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>./myapp --os-auth-plugin v3password <span class="se">\</span>
</span><span class='line'>        --os-auth-url http://keystone.test:5000/v3 <span class="se">\</span>
</span><span class='line'>        --os-username user <span class="se">\</span>
</span><span class='line'>        --os-password pass <span class="se">\</span>
</span><span class='line'>        --os-user-domain-name domain <span class="se">\</span>
</span><span class='line'>        --os-project-name proj <span class="se">\</span>
</span><span class='line'>        --os-project-domain-name domain
</span><span class='line'>        <span class="nb">command</span>
</span></code></pre></td></tr></table></div></figure>

Or

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">OS_AUTH_PLUGIN</span><span class="o">=</span>v3password
</span><span class='line'><span class="nb">export </span><span class="nv">OS_AUTH_URL</span><span class="o">=</span>http://keystone.test:5000/v3
</span><span class='line'><span class="nb">export </span><span class="nv">OS_USERNAME</span><span class="o">=</span>user
</span><span class='line'><span class="nb">export </span><span class="nv">OS_PASSWORD</span><span class="o">=</span>pass
</span><span class='line'><span class="nb">export </span><span class="nv">OS_USER_DOMAIN_NAME</span><span class="o">=</span>domain
</span><span class='line'><span class="nb">export </span><span class="nv">OS_PROJECT_NAME</span><span class="o">=</span>proj
</span><span class='line'><span class="nb">export </span><span class="nv">OS_PROJECT_DOMAIN_NAME</span><span class="o">=</span>domain
</span><span class='line'>
</span><span class='line'>./myapp <span class="nb">command</span>
</span></code></pre></td></tr></table></div></figure>

This is loaded from python via:

<div><script src='https://gist.github.com/4e22049c5bc57f4b68ec.js?file=test-cli.py'></script>
<noscript><pre><code>import argparse
import sys

from keystoneclient import auth
from keystoneclient import session

parser = argparse.ArgumentParser('myapp')

auth.register_argparse_arguments(parser, sys.argv[1:])
session.Session.register_cli_options(parser)

args = parser.parse_args()

plugin = auth.load_from_argparse_arguments(args)
sess = session.Session.load_from_cli_options(args, auth=plugin)
</code></pre></noscript></div>


**NOTE**: I am aware that the syntax is wonky with the command for session loading and auth plugin loading different.
This was one of those things that was &#8216;optimized&#8217; between reviews and managed to slip through.
There is a review out to standardize this.

This will also set `&#8211;help` appropriately, so if you are unsure of the arguments that this particular authentication plugin takes you can do:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>./myapp --os-auth-plugin v3password --help
</span><span class='line'>
</span><span class='line'>usage: myapp <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>--os-auth-plugin &lt;name&gt;<span class="o">]</span> <span class="o">[</span>--os-auth-url OS_AUTH_URL<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-domain-id OS_DOMAIN_ID<span class="o">]</span> <span class="o">[</span>--os-domain-name OS_DOMAIN_NAME<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-project-id OS_PROJECT_ID<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-project-name OS_PROJECT_NAME<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-project-domain-id OS_PROJECT_DOMAIN_ID<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-project-domain-name OS_PROJECT_DOMAIN_NAME<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-trust-id OS_TRUST_ID<span class="o">]</span> <span class="o">[</span>--os-user-id OS_USER_ID<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-user-name OS_USERNAME<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-user-domain-id OS_USER_DOMAIN_ID<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-user-domain-name OS_USER_DOMAIN_NAME<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-password OS_PASSWORD<span class="o">]</span> <span class="o">[</span>--insecure<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-cacert &lt;ca-certificate&gt;<span class="o">]</span> <span class="o">[</span>--os-cert &lt;certificate&gt;<span class="o">]</span>
</span><span class='line'>             <span class="o">[</span>--os-key &lt;key&gt;<span class="o">]</span> <span class="o">[</span>--timeout &lt;seconds&gt;<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>optional arguments:
</span><span class='line'>  -h, --help            show this <span class="nb">help </span>message and <span class="nb">exit</span>
</span><span class='line'>  --os-auth-plugin &lt;name&gt;
</span><span class='line'>                        The auth plugin to load
</span><span class='line'>  --insecure            Explicitly allow client to perform <span class="s2">&quot;insecure&quot;</span> TLS
</span><span class='line'>                        <span class="o">(</span>https<span class="o">)</span> requests. The server<span class="s1">&#39;s certificate will not be</span>
</span><span class='line'><span class="s1">                        verified against any certificate authorities. This</span>
</span><span class='line'><span class="s1">                        option should be used with caution.</span>
</span><span class='line'><span class="s1">  --os-cacert &lt;ca-certificate&gt;</span>
</span><span class='line'><span class="s1">                        Specify a CA bundle file to use in verifying a TLS</span>
</span><span class='line'><span class="s1">                        (https) server certificate. Defaults to</span>
</span><span class='line'><span class="s1">                        env[OS_CACERT].</span>
</span><span class='line'><span class="s1">  --os-cert &lt;certificate&gt;</span>
</span><span class='line'><span class="s1">                        Defaults to env[OS_CERT].</span>
</span><span class='line'><span class="s1">  --os-key &lt;key&gt;        Defaults to env[OS_KEY].</span>
</span><span class='line'><span class="s1">  --timeout &lt;seconds&gt;   Set request timeout (in seconds).</span>
</span><span class='line'>
</span><span class='line'><span class="s1">Authentication Options:</span>
</span><span class='line'><span class="s1">  Options specific to the v3password plugin.</span>
</span><span class='line'>
</span><span class='line'><span class="s1">  --os-auth-url OS_AUTH_URL</span>
</span><span class='line'><span class="s1">                        Authentication URL</span>
</span><span class='line'><span class="s1">  --os-domain-id OS_DOMAIN_ID</span>
</span><span class='line'><span class="s1">                        Domain ID to scope to</span>
</span><span class='line'><span class="s1">  --os-domain-name OS_DOMAIN_NAME</span>
</span><span class='line'><span class="s1">                        Domain name to scope to</span>
</span><span class='line'><span class="s1">  --os-project-id OS_PROJECT_ID</span>
</span><span class='line'><span class="s1">                        Project ID to scope to</span>
</span><span class='line'><span class="s1">  --os-project-name OS_PROJECT_NAME</span>
</span><span class='line'><span class="s1">                        Project name to scope to</span>
</span><span class='line'><span class="s1">  --os-project-domain-id OS_PROJECT_DOMAIN_ID</span>
</span><span class='line'><span class="s1">                        Domain ID containing project</span>
</span><span class='line'><span class="s1">  --os-project-domain-name OS_PROJECT_DOMAIN_NAME</span>
</span><span class='line'><span class="s1">                        Domain name containing project</span>
</span><span class='line'><span class="s1">  --os-trust-id OS_TRUST_ID</span>
</span><span class='line'><span class="s1">                        Trust ID</span>
</span><span class='line'><span class="s1">  --os-user-id OS_USER_ID</span>
</span><span class='line'><span class="s1">                        User ID</span>
</span><span class='line'><span class="s1">  --os-user-name OS_USERNAME, --os-username OS_USERNAME</span>
</span><span class='line'><span class="s1">                        Username</span>
</span><span class='line'><span class="s1">  --os-user-domain-id OS_USER_DOMAIN_ID</span>
</span><span class='line'><span class="s1">                        User&#39;</span>s domain id
</span><span class='line'>  --os-user-domain-name OS_USER_DOMAIN_NAME
</span><span class='line'>                        User<span class="s1">&#39;s domain name</span>
</span><span class='line'><span class="s1">  --os-password OS_PASSWORD</span>
</span><span class='line'><span class="s1">                        User&#39;</span>s password
</span></code></pre></td></tr></table></div></figure>

To prevent polluting your CLI&#8217;s help only the &#8216;Authentication Options&#8217; for the plugin you specified by &#8216;&#8211;os-auth-plugin&#8217; are added to the help.

Having explained all this one of the primary application currently embracing authentication plugins, [openstackclient](https://github.com/openstack/python-openstackclient), currently handles its options slightly differently and you will need to use `&#8211;os-auth-type` instead of `&#8211;os-auth-plugin`

## Available plugins

The [documentation](http://docs.openstack.org/developer/python-keystoneclient/authentication-plugins.html) for plugins provides basic features and parameters however it&#8217;s not always going to be up to date with all options, especially for plugins not handled within keystoneclient.
The following is a fairly simple script that lists all the plugins that are installed on the system and their options.

<div><script src='https://gist.github.com/7f5cfabd64a6922e643c.js?file=list-plugins.py'></script>
<noscript><pre><code>import stevedore

mgr = stevedore.ExtensionManager(namespace='keystoneclient.auth.plugin',
                                 invoke_on_load=False)

def print_plugin(ext):
    print &quot;%s:&quot; % ext.entry_point.name

    for opt in ext.plugin.get_options():
        print &quot;    %s: %s&quot; % (opt.name, opt.help)

mgr.map(print_plugin)
</code></pre></noscript></div>


Which for the `v3password` plugin we&#8217;ve been using returns:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>...
</span><span class='line'>v3password:
</span><span class='line'>    auth-url: Authentication URL
</span><span class='line'>    domain-id: Domain ID to scope to
</span><span class='line'>    domain-name: Domain name to scope to
</span><span class='line'>    project-id: Project ID to scope to
</span><span class='line'>    project-name: Project name to scope to
</span><span class='line'>    project-domain-id: Domain ID containing project
</span><span class='line'>    project-domain-name: Domain name containing project
</span><span class='line'>    trust-id: Trust ID
</span><span class='line'>    user-id: User ID
</span><span class='line'>    user-name: Username
</span><span class='line'>    user-domain-id: User<span class="s1">&#39;s domain id</span>
</span><span class='line'><span class="s1">    user-domain-name: User&#39;</span>s domain name
</span><span class='line'>    password: User<span class="err">&#39;</span>s password
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>

From that it&#8217;s pretty simple to determine the correct format for parameters.

 - When using the CLI you should prefix `&#8211;os-`, e.g. `auth-url` becomes `&#8211;os-auth-url`.
 - Environment variables are upper-cased, and prefix `OS_` and replace `-` with `_`, e.g. `auth-url` becomes `OS_AUTH_URL`.
 - Conf file variables replace `-` with `_` eg. `auth-url` becomes `auth_url`.
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PKI Tokens Don't Give Better Security]]></title>
    <link href="http://www.jamielennox.net/blog/2014/12/01/pki-tokens-dont-give-better-security/"/>
    <updated>2014-12-01T13:55:29+11:00</updated>
    <id>http://www.jamielennox.net/blog/2014/12/01/pki-tokens-dont-give-better-security</id>
    <content type="html"><![CDATA[This will be real quick.

Every now and then I come across something that mentions how you should use PKI tokens in keystone as the cryptography gives it better security.
It happened today and so I thought I should clarify:

__There is no added security benefit to using keystone with PKI tokens over UUID tokens.__

There are advantages to PKI tokens:

 - Token validation without a request to keystone means less impact on keystone.

And there are disadvantages:

 - Larger token size.
 - Additional complexity to set up.

However the fundamental model, that this opaque chunk of data in the 'X-Auth-Token' header indicates that this request is authenticated does not change between PKI and UUID tokens.
If someone steals your PKI token you are just as screwed as if they stole your UUID token.
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Use Keystoneclient Sessions]]></title>
    <link href="http://www.jamielennox.net/blog/2014/09/15/how-to-use-keystoneclient-sessions/"/>
    <updated>2014-09-15T09:13:36+10:00</updated>
    <id>http://www.jamielennox.net/blog/2014/09/15/how-to-use-keystoneclient-sessions</id>
    <content type="html"><![CDATA[In the last post I did on keystoneclient sessions there was a lot of hand waving about how they should work but it's not merged yet.
Standardizing clients has received some more attention again recently - and now that the sessions are more mature and ready it seems like a good opportunity to explain them and how to use them again.

For those of you new to this area the clients have grown very organically, generally forking off some existing client and adding and removing features in ways that worked for that project.
Whilst this is in general a problem for user experience (try to get one token and use it with multiple clients without reauthenticating) it is a nightmare for security fixes and new features as they need to be applied individually across each client.

Sessions are an attempt to extract a common authentication and communication layer from the existing clients so that we can handle transport security once, and keystone and deployments can add new authentication mechanisms without having to do it for every client.

The Basics
----------

Sessions and authentications are user facing objects that you create and pass to a client, they are public objects not a framework for the existing clients.
They require a change in how you instantiate clients.

The first step is to create an authentication plugin, currently the available plugins are:

- ``keystoneclient.auth.identity.v2.Password``
- ``keystoneclient.auth.identity.v2.Token``
- ``keystoneclient.auth.identity.v3.Password``
- ``keystoneclient.auth.identity.v3.Token``
- ``keystoneclient.auth.token_endpoint.Token``

For the primary user/password and token authentication mechanisms that keystone supports in v2 and v3 and for the test case where you know the endpoint and token in advance.
The parameters will vary depending upon what is required to authenticate with each.

Plugins don't need to live in the keystoneclient, we are currently in the process of setting up a new repository for kerberos authentication so that it will be an optional dependency.
There are also some plugins living in the contrib section of keystoneclient for federation that will also likely be moved to a new repository soon.

You can then create a session with that plugin.

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">keystoneclient</span> <span class="kn">import</span> <span class="n">session</span> <span class="k">as</span> <span class="n">ksc_session</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">keystoneclient.auth.identity</span> <span class="kn">import</span> <span class="n">v3</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">keystoneclient.v3</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">keystone_v3</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">novaclient.v1_1</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">nova_v2</span>
</span><span class='line'>
</span><span class='line'><span class="n">auth</span> <span class="o">=</span> <span class="n">v3</span><span class="o">.</span><span class="n">Password</span><span class="p">(</span><span class="n">auth_url</span><span class="o">=</span><span class="s">&#39;http://keystone.host/v3&#39;</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">username</span><span class="o">=</span><span class="s">&#39;user&#39;</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">password</span><span class="o">=</span><span class="s">&#39;password&#39;</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">project_name</span><span class="o">=</span><span class="s">&#39;demo&#39;</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">user_domain_name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">project_domain_name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">session</span> <span class="o">=</span> <span class="n">ksc_session</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">verify</span><span class="o">=</span><span class="s">&#39;/path/to/ca.cert&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">keystone</span> <span class="o">=</span> <span class="n">keystone_v3</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</span><span class='line'><span class="n">nova</span> <span class="o">=</span> <span class="n">nova_v2</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

Keystone and nova clients will now share an authentication token fetched with keystone&#8217;s v3 authentication.
The clients will authenticate on the first request and will re-authenticate automatically when the token expires.

This is a fundamental shift from the existing clients that would authenticate internally to the client and on creation so by opting to use sessions you are acknowledging that some methods won&#8217;t work like they used to.
For example keystoneclient had an &#8220;`authenticate()&#8220;` function that would save the details of the authentication (user\_id etc) on the client object.
This process is no longer controlled by keystoneclient and so this function should not be used, however it also cannot be removed because we need to remain backwards compatible with existing client code.

In converting the existing clients we consider that passing a Session means that you are acknowledging that you are using new code and are opting-in to the new behaviour.
This will not affect 90% of users who just make calls to the APIs, however if you have got hacks in place to share tokens between the existing clients or you overwrite variables on the clients to force different behaviours then these will probably be broken.

Per-Client Authentication
&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-

The above flow is useful for users where they want to have there one token shared between one or more clients.
If you are are an application that uses many authentication plugins (eg, heat or horizon) you may want to take advantage of using a single session&#8217;s connection pooling or caching whilst juggling multiple authentications.
You can therefore create a session without an authentication plugin and specify the plugin that will be used with that client instance, for example:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">global</span> <span class="n">SESSION</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="ow">not</span> <span class="n">SESSION</span><span class="p">:</span>
</span><span class='line'>    <span class="n">SESSION</span> <span class="o">=</span> <span class="n">ksc_session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">auth</span> <span class="o">=</span> <span class="n">get_auth_plugin</span><span class="p">()</span>  <span class="c"># you could deserialize it from a db,</span>
</span><span class='line'>                          <span class="c"># fetch it based on a cookie value...</span>
</span><span class='line'><span class="n">keystone</span> <span class="o">=</span> <span class="n">keystone_v3</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">SESSION</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

Auth plugins set on the client will override any auth plugin set on the session - but I&#8217;d recommend you pick one method based on your application&#8217;s needs and stick with it.

Loading from a config file
&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;

There is support for loading session and authentication plugins from and oslo.config CONF object.
The documentation on exactly what options are supported is lacking right now and you will probably need to look at code to figure out everything that is supported.
I promise to improve this, but to get you started you need to register the options globally:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">group</span> <span class="o">=</span> <span class="s">&#39;keystoneclient&#39;</span>  <span class="c"># the option group</span>
</span><span class='line'><span class="n">keystoneclient</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">register_conf_options</span><span class="p">(</span><span class="n">CONF</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span><span class='line'><span class="n">keystoneclient</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">register_conf_options</span><span class="p">(</span><span class="n">CONF</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

And then load the objects where you need them:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">auth</span> <span class="o">=</span> <span class="n">keystoneclient</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">load_from_conf_options</span><span class="p">(</span><span class="n">CONF</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span><span class='line'><span class="n">session</span> <span class="o">=</span> <span class="n">ksc_session</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">load_from_conf_options</span><span class="p">(</span><span class="n">CONF</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>
</span><span class='line'><span class="n">keystone</span> <span class="o">=</span> <span class="n">keystone_v3</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

Will load options that look like:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[keystoneclient]</span>
</span><span class='line'><span class="na">cacert</span> <span class="o">=</span> <span class="s">/path/to/ca.cert</span>
</span><span class='line'><span class="na">auth_plugin</span> <span class="o">=</span> <span class="s">v3password</span>
</span><span class='line'><span class="na">username</span> <span class="o">=</span> <span class="s">user</span>
</span><span class='line'><span class="na">password</span> <span class="o">=</span> <span class="s">password</span>
</span><span class='line'><span class="na">project_name</span> <span class="o">=</span> <span class="s">demo</span>
</span><span class='line'><span class="na">project_domain_name</span> <span class="o">=</span> <span class="s">default</span>
</span><span class='line'><span class="na">user_domain_name</span> <span class="o">=</span> <span class="s">default</span>
</span></code></pre></td></tr></table></div></figure>

There is also support for transitioning existing code bases to new option names if they are not the same as what your application uses.

Loading from CLI
&#8212;&#8212;&#8212;&#8212;&#8212;-

A very similar process is used to load sessions and plugins from an argparse parser.

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span class='line'>
</span><span class='line'><span class="n">keystoneclient</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">register_cli_options</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
</span><span class='line'><span class="n">keystoneclient</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">register_argparse_arguments</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">auth</span> <span class="o">=</span> <span class="n">keystoneclient</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">load_from_argparse_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="n">session</span> <span class="o">=</span> <span class="n">keystoneclient</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">load_from_cli_options</span><span class="p">(</span><span class="n">args</span><span class="p">,</span>
</span><span class='line'>                                                               <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

This produces an application with the following options:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>python test.py --os-auth-plugin v3password
</span><span class='line'>usage: <span class="nb">test</span> <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>--insecure<span class="o">]</span> <span class="o">[</span>--os-cacert &lt;ca-certificate&gt;<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-cert &lt;certificate&gt;<span class="o">]</span> <span class="o">[</span>--os-key &lt;key&gt;<span class="o">]</span> <span class="o">[</span>--timeout &lt;seconds&gt;<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-auth-plugin &lt;name&gt;<span class="o">]</span> <span class="o">[</span>--os-auth-url OS_AUTH_URL<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-domain-id OS_DOMAIN_ID<span class="o">]</span> <span class="o">[</span>--os-domain-name OS_DOMAIN_NAME<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-project-id OS_PROJECT_ID<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-project-name OS_PROJECT_NAME<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-project-domain-id OS_PROJECT_DOMAIN_ID<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-project-domain-name OS_PROJECT_DOMAIN_NAME<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-trust-id OS_TRUST_ID<span class="o">]</span> <span class="o">[</span>--os-user-id OS_USER_ID<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-user-name OS_USERNAME<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-user-domain-id OS_USER_DOMAIN_ID<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-user-domain-name OS_USER_DOMAIN_NAME<span class="o">]</span>
</span><span class='line'>            <span class="o">[</span>--os-password OS_PASSWORD<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>

There is an ongoing effort to create a standardized CLI plugin that can be used by new clients rather than have people provide an &#8211;os-auth-plugin every time.
It is not yet ready, however clients can create and specify there own default plugins if &#8211;os-auth-plugin is not provided.


For Client Authors
&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;

To make use of the session in your client there is the &#8220;`keystoneclient.adapter.Adapter&#8220;` which provides you with a set of standard variables that your client should take and use with the session.
The adapter will handle the per-client authentication plugins, handle &#8220;`region_name&#8220;`, &#8220;`interface&#8220;`, &#8220;`user_agent&#8220;` and similar client parameters that are not part of the more global (across many clients) state that sessions hold.

The basic client should look like:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>class MyClient<span class="o">(</span>object<span class="o">)</span>:
</span><span class='line'>
</span><span class='line'>    def __init__<span class="o">(</span>self, **kwargs<span class="o">)</span>:
</span><span class='line'>        kwargs.set_default<span class="o">(</span><span class="s1">&#39;user_agent&#39;</span>, <span class="s1">&#39;python-myclient&#39;</span><span class="o">)</span>
</span><span class='line'>        kwargs.set_default<span class="o">(</span><span class="s1">&#39;service_type&#39;</span>, <span class="s1">&#39;my&#39;</span><span class="o">)</span>
</span><span class='line'>        self.http <span class="o">=</span> keystoneclient.adapter.Adapter<span class="o">(</span>**kwargs<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>

The adapter then has &#8220;`.get()&#8220;` and &#8220;`.post()&#8220;` and other http methods that the clients expect.

Conclusion
&#8212;&#8212;&#8212;-

It&#8217;s great to have renewed interest in standardizing client behaviour, and I&#8217;m thrilled to see better session adoption.
The code has matured to the point it is usable and simplifies use for both users and client authors.

In writing this I kept wanting to link out to official documentation and realized just how lacking it really is.
Some explanation is available on the [official python-keystoneclient docs pages](http://docs.openstack.org/developer/python-keystoneclient/using-sessions.html), there is also [module documentation](http://docs.openstack.org/developer/python-keystoneclient/api/keystoneclient.auth.identity.html) however this is definetly an area in which we (read I) am a long way behind.
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Identity_uri in Auth Token Middleware]]></title>
    <link href="http://www.jamielennox.net/blog/2014/05/21/identity-uri-in-auth-token-middleware/"/>
    <updated>2014-05-21T14:54:00+10:00</updated>
    <id>http://www.jamielennox.net/blog/2014/05/21/identity-uri-in-auth-token-middleware</id>
    <content type="html"><![CDATA[As part of the 0.8 release of keystoneclient (2014-04-17) we made an update to the way that you configure auth\_token middleware in OpenStack.

Previously you specify the path to the keystone server as a number of individual parameters such as:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>keystone_authtoken<span class="o">]</span>
</span><span class='line'><span class="nv">auth_protocol</span> <span class="o">=</span> http
</span><span class='line'><span class="nv">auth_port</span> <span class="o">=</span> 35357
</span><span class='line'><span class="nv">auth_host</span> <span class="o">=</span> 127.0.0.1
</span><span class='line'><span class="nv">auth_admin_prefix</span> <span class="o">=</span>
</span></code></pre></td></tr></table></div></figure>

This made sense in code when using httplib for communication where you use each of those independent pieces.
However we removed httplib a number of releases ago and now simply reconstruct the full URL in code in the form:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>%<span class="o">(</span>auth_protocol<span class="o">)</span>s://%<span class="o">(</span>auth_host<span class="o">)</span>s:%<span class="o">(</span>auth_port<span class="o">)</span>d/%<span class="o">(</span>auth_admin_prefix<span class="o">)</span>s
</span></code></pre></td></tr></table></div></figure>

This format is much more intuitive for configuration and so should now be used with the key **identity\_uri**. e.g.

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>keystone_authtoken<span class="o">]</span>
</span><span class='line'><span class="nv">identity_uri</span> <span class="o">=</span> http://127.0.0.1:35357
</span></code></pre></td></tr></table></div></figure>

Using the original format will continue to work but you&#8217;ll see a deprecation message like:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>WARNING keystoneclient.middleware.auth_token <span class="o">[</span>-<span class="o">]</span> Configuring admin URI using auth fragments. This is deprecated, use <span class="s1">&#39;identity_uri&#39;</span> instead.
</span></code></pre></td></tr></table></div></figure>
]]></content>
  </entry>
  
</feed>
